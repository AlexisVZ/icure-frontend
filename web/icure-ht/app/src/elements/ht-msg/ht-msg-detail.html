<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/paper-styles/shadow.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">

<link rel="import" href="../../../bower_components/iron-meta/iron-meta.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../bower_components/iron-iconset-svg/iron-iconset-svg.html">
<link rel="import" href="../../../bower_components/iron-iconset/iron-iconset.html">



<link rel="import" href="../../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../../bower_components/iron-icons/hardware-icons.html">
<link rel="import" href="../../../bower_components/iron-icons/image-icons.html">
<link rel="import" href="../../../bower_components/iron-icons/editor-icons.html">


<link rel="import" href="../../../bower_components/vaadin-icons/vaadin-icons.html">
<link rel="import" href="../../../bower_components/vaadin-upload/vaadin-upload.html">
<link rel="import" href="../../../bower_components/vaadin-checkbox/vaadin-checkbox.html">

<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input-container.html">
<link rel="import" href="../../../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../bower_components/paper-listbox/paper-listbox.html">

<link rel="import" href="../../../bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="../ht-spinner/ht-spinner.html">

<link rel="import" href="../../../bower_components/paper-dialog/paper-dialog.html">

<link rel="import" href="../filter-panel/filter-panel.html">
<link rel="import" href="../../../bower_components/paper-fab-speed-dial/paper-fab-speed-dial.html">
<link rel="import" href="../../../bower_components/paper-fab-speed-dial/paper-fab-speed-dial-action.html">

<link rel="import" href="../dynamic-form/dynamically-loaded-form.html">
<link rel="import" href="../dynamic-form/entity-selector.html">
<link rel="import" href="../dynamic-form/dynamic-doc.html">

<link rel="import" href="../pdf-element/pdf-element.html">



<dom-module id="ht-msg-detail">



	<template>



		<style include="shared-style">

			:host{
				position: relative;
				background: var(--app-background-color-light);
				overflow-y: auto;
			}

			.notification-panel {
				position: fixed;
				top:50%;
				right: 0;
				z-index:1000;
				color: white;
				font-size: 13px;
				background: rgba(255, 0, 0, 0.55);
				height: 96px;
				padding: 0 8px 0 12px;
				border-radius: 3px 0 0 3px;
				overflow: hidden;
				white-space: nowrap;
				width: 0;
				opacity: 0;
			}

			.notification {
				animation: notificationAnim 7.5s ease-in;
			}

			@keyframes notificationAnim {
				0%{
					width: 0;
					opacity: 0;
				}
				5%{
					width: 440px;
					opacity: 1;
				}
				7%{
					width: 420px;
					opacity: 1;
				}
				95%{
					width: 420px;
					opacity: 1;
				}
				100%{
					width: 0;
					opacity: 0;
				}
			}

			.prescription-progress-bar {
				width: calc( 100% - 40px );
			}

			.details-panel {
				box-sizing: border-box;
				grid-column: 3 / span 1;
				grid-row: 1 / span 1;
				background: var(--app-background-color-light);
				display: flex;
				overflow-y: auto;
				flex-flow: column nowrap;
				align-items: flex-start;
				z-index: 0;
				width: 100%;
                flex: 1;
                padding: 0 10px;
			}

			.contact-title{
				display:block;
				@apply --paper-font-body2;
				@apply --padding-32;
				padding-bottom:8px;
				padding-top: 32px;
			}

			.msg-detail-card > .card-content {
				padding: 16px 16px 32px !important;
			}

			.msg-detail-card {
				width: 100%;
                padding: 0 16px 8px 16px;
				display: block;
				background: transparent;
                flex-grow: 0;
                margin-top:10px;
                border: 1px solid #ccc;
                box-shadow:none;
			}

			.horizontal {
				display: flex;
				flex-direction: row;
				flex-wrap: wrap;
				flex-basis: 100%;
			}

			.justified {
				justify-content: space-between;
			}

			.pat-details-input {
				flex-grow: 1;
				margin: 16px;
			}

			input {
				border: none;
				width: 100%;
			}

			paper-dialog {
				margin: 0;
			}

			.contact-card-container {
				position: relative;
				overflow-y: auto;
				height: calc(100% - 48px);
				padding-bottom: 32px;
			}

			paper-dialog {
				min-width:30%;
			}

			.extra-info{
				color:var(--app-text-color-disabled);
				font-style: italic;
				font-size: 80%;
			}

			vaadin-upload{
				margin:16px;
				min-height:280px;
				background: var(--app-background-color);
				--vaadin-upload-buttons-primary: {
					padding:16px;
				};
				--vaadin-upload-button-add: {
					background: var(--app-secondary-color);
					color:var(--app-text-color);
				};
				--vaadin-upload-file-progress: {
					--paper-progress-active-color:var(--app-secondary-color);
				};
				--vaadin-upload-file-commands: {
					color: var(--app-primary-color);
				}

			}

			.close-button-icon{
				position: absolute;
				top: 0;
				right: 0;
				margin: 0;
				transform: translate(50%, -50%);
				height: 32px;
				width: 32px;
				padding: 8px;
				background: var(--app-primary-color);
			}

			paper-dialog {
				width: 80%;
			}

			vaadin-grid {
				height:100%;
				--vaadin-grid-body-row-hover-cell: {
					/* background-color: var(--app-primary-color); */
					color: white;
				};
				--vaadin-grid-body-row-selected-cell: {
					background-color: var(--app-primary-color);
					color: white;
				};
			}

			paper-input{
				--paper-input-container-focus-color: var(--app-primary-color);
			}

			.modal-title {
				background:  var(--app-background-color-dark);
				margin-top: 0;
				padding: 16px 24px;
				margin-bottom:0;
			}

			.modal-subtitle{
				display: inline-flex;
				margin-top: 16px;
			}

			.modal-button{
				--paper-button-ink-color: var(--app-secondary-color-dark);
				color: var(--app-text-color);
				font-weight: 400;
				font-size: 14px;
				height: 40px;
				min-width: 100px;
				padding: 10px 1.2em;
				text-transform: capitalize;
			}
            @media screen and (max-width: 1314px) {
                .modal-button {
                    margin: 0;
                }
            }

			.modal-button--save{
				box-shadow: var(--shadow-elevation-2dp_-_box-shadow);
				background: var(--app-secondary-color);
				color: var(--app-primary-color-dark);
				font-weight: 700;
			}

			.modal-button--delete{
				box-shadow: var(--shadow-elevation-2dp_-_box-shadow);
				background: var(--app-background-color-light);
				color: var(--app-primary-color-dark);
				font-weight: 700;
			}
            @media screen and (max-width: 1200px) {
                .modal-button--delete.remove {
                    display: none;
                }
            }

			filter-panel{
				flex-grow: 9;
				/* --panel-width: 60%; */
			}

			.layout-bar{
				flex-grow: 1;
				display: inline-flex;
				flex-flow: row nowrap;
				align-items: center;
				justify-content: space-around;
				height:48px;
				background: var(--app-secondary-color);
				border-left: 1px solid var(--app-secondary-color-dark);
			}

			.layout-bar .list, .layout-bar .graphique, .layout-bar .doc{
				height: 32px;
				width: 32px;
				padding: 5px;
				color: var(--app-primary-color-dark);
			}

			.layout-bar .table{
				height: 30px;
				width: 30px;
				padding: 0;
				color: var(--app-primary-color-dark);
			}

			.floating-action-bar{
				display: flex;
				position: absolute;
				height: 40px;
				bottom: 16px;
				background: var(--app-secondary-color);
				border-radius: 3px;
				grid-column: 3/3;
				grid-row: 1/1;
				z-index: 1000;
				left: 50%;
				transform: translate(-50%, 0);
				box-shadow: var(--app-shadow-elevation-2);
			}

			.add-forms-container {
				position: absolute;
				bottom: 48px;
				left: 0;
				background-color: var(--app-background-color-light);
				opacity: .8;
				padding: 8px 0;
				border-radius: 2px;
				max-width: 253px;
			}
			.floating-action-bar paper-fab-speed-dial-action {
				--paper-fab-speed-dial-action-label-background: transparent;
				--paper-fab-iron-icon: {
					transform: scale(0.8);

				};
				--paper-fab: {
					background: var(--app-primary-color-dark);
				}
			}

			.floating-action-bar paper-button{
				--paper-button-ink-color: var(--app-secondary-color-dark);
				background: var(--app-secondary-color);
				color: var(--app-text-color);
				font-weight: bold;
				font-size: 12px;
				height: 40px;
				min-width: 130px;
				padding: 10px 1.2em;
				border-radius: 0;
				margin:0;
			}

			.floating-action-bar paper-button:hover{
				background: var(--app-dark-color-faded);
    			transition: var(--transition_-_transition);
			}

			.floating-action-bar paper-button:not(:first-child){
				border-left: 1px solid var(--app-secondary-color-dark);
			}

			.close-add-forms-btn{
				background: var(--app-secondary-color-dark) !important;
			}

			.floating-action-bar iron-icon{
				box-sizing: border-box;
				padding: 2px;
				margin-right: 8px;
			}

			.horizontal{
				flex-flow: row nowrap;
			}

			.contact-card-container {
				position: relative;
				overflow-y: auto;
				height: calc(100% - 48px);
				padding-bottom: 32px;
			}

            dynamic-doc {
                overflow-x: hidden;
                overflow-y: auto;
                margin-top: 16px;
                word-break: break-all;
                hyphens: auto;
            }

			.annexe-card{
                width: 100%;
                box-sizing: border-box;
				background: var(--app-background-color)
			}

			.annexe-card:first-of-type{
				margin-left:0;
			}

			.annexe-card--header{
				background-color: white;
    			padding: 0 8px;
				flex-flow: row nowrap!important;
                overflow: hidden;
                text-overflow: ellipsis;
			}

			.annexe-card--header span{
				flex-grow: 1;
				overflow: hidden;
				text-overflow: ellipsis;
				white-space: nowrap;
			}

			.annexe-card--header paper-icon-button{
				height: 32px;
				width: 32px;
				min-width: 32px;
				min-height: 32px;
				padding: 4px;
				opacity: .7;
				color: var(--app-text-color);
			}

			.annexe-card--content{
    			padding: 0 8px;
			}

			.annexe-card--action-button{
				font-size: 14px;
				font-weight: 400;
				text-transform: capitalize;
                margin: 0 auto;
			}

			.annexe-card--action-button:hover{
				background-color: var(--app-background-color-dark);
				font-weight: 500;
			}

			.img-container img{
				max-width: 100%;
				height: auto;
			}

            .action-buttons {
                width: 100%;
                padding: 0;
				border: 1px solid #ccc;
				height: 56px;
                z-index: 10;
                padding: 8px;
                box-sizing: border-box;
                display: flex;
                flex-flow: row wrap;
                justify-content: space-between;
                align-items: center;
                box-shadow:0px 1px 1px #bbb;
            }

            .buttons{
                display: flex;
                flex-flow: row wrap;
                justify-content: flex-start;
                align-items: center;
            }

            .dialogButtons {
                position:fixed;
                bottom:60px;
                right:60px;
            }

            .clearb {
                clear: both;
            }
            .flexbox {
                display: flex;
                flex-direction: row;
            }
            .flexbox.read {
                width: 100%;
            }
            .inlined {
                flex: 1;
                float: left;
                width: 30%;
                margin: 0 1%;
            }

            .read-txt {
                width: 100%;
                max-height: 50vh;
                overflow-y: auto;
				flex-grow: 1;
				border-top: 1px solid var(--app-background-color-dark);
                padding: 0 10px;
                box-sizing: border-box;
            }

			.read-txt p{
				font-size: 14px;
			}

            .attached {
                width: 100%;
                max-height: 176px;
                padding: 10px;
                overflow-y: auto;
                border-top: 1px solid var(--app-background-color-dark);
                box-sizing: border-box;
				display: flex;
				flex-flow: row wrap;
				justify-content: flex-start;
				align-items: flex-start;
            }
            .attached paper-button {
                margin: 0;
            }

			.attached h3{
				width: 100%;
				margin: 0;
				color: var(--app-text-color);
				font-size: 1em;
				padding-left:4px;
			}

			.msg-detail-btn{
				font-size: 14px;
				font-weight: 400;
				color: var(--app-text-color);
				transition: all .12s cubic-bezier(0.075, 0.82, 0.165, 1);
				margin-bottom: 8px;
				height: 40px;
				text-transform: none;
			}

			.msg-detail-btn:hover{
				background-color: var(--app-background-color-dark);
				color: var(--app-text-color);
			}

			.msg-detail-btn iron-icon{
				height: 20px;
				width: 20px;
				padding: 4px;
				opacity: .7;
				color: var(--app-text-color);
			}

			.layout-horizontal{
				display:flex;
				flex-flow: row wrap;
				align-items: center;
				justify-content: flex-start;
			}

			.layout-horizontal--nowrap{
				flex-flow: row nowrap;
			}

            .justify-content {
                justify-content: space-between;
                flex-flow: initial;
            }
			.space-between{
				justify-content: space-between;
                height: 80px;
			}

			.layout-horizontal--flex-end{
				justify-content: flex-end;
			}

			.msg-header-grid{
				display: grid;
				grid-template-columns: 40px 1fr;
				grid-template-rows: 20px 20px;
				grid-row-gap: 0;
				grid-column-gap: 8px;
			}

			.initials-avatar{
				grid-column: 1 / 1;
				grid-row: 1 / 2;
				display: inline-flex;
				flex-flow: row wrap;
				align-items: center;
				justify-content: center;
				background: var(--app-secondary-color-dark);
				border-radius: 50%;
				height: 40px;
                width: 40px;
				color: white;
				font-size: 1.2em;
				text-transform: uppercase;
			}

			.senderDetails {
				-webkit-font-smoothing: antialiased;
				font-family: Roboto,RobotoDraft,Helvetica,Arial,sans-serif;
				font-size: 1rem;
				letter-spacing: .2px;
				color: var(--app-text-color);
				line-height: 20px;
				font-weight: 500;
				grid-column: 2 / 2;
				grid-row: 1 / 1;
				place-self: end start;
			}

			.to{
				-webkit-font-smoothing: auto;
				font-family: Roboto,RobotoDraft,Helvetica,Arial,sans-serif;
				font-size: 13px;
				letter-spacing: .3px;
				color: var(--app-text-color-disabled);
				line-height: 20px;
				grid-column: 2 / 2;
				grid-row: 2 / 2;
				place-self: start start;
			}

			paper-icon-button{
				color: var(--app-text-color);
				height: 32px;
				width: 32px;
				padding: 4px;
				margin: 4px;
				transition: all .12s cubic-bezier(0.075, 0.82, 0.165, 1);
				opacity: .7;
			}

			paper-icon-button:hover{
				border-radius: 50%;
				background-color: var(--app-background-color-dark);
				color: var(--app-text-color);
				opacity: 1;
			}

			.date{
				font-size: 13px;
				background-color: var(--app-background-color-dark);
				padding: 0 12px;
				border-radius: 12px;
				color: var(--app-text-color);
			}

			paper-spinner.patlist-spinner {
                position: relative;
                top: 12px;
                left: 8px;
                transform: none;
            }

            .close-panel {
                width: 100%;
                text-align: center;
                padding: 4px 16px;
                box-sizing: border-box;
                background: var(--app-background-color-darker);
                cursor: pointer;
                border-top: 1px solid black;
            }

            #main-details-panel {
                flex: 1;
            }

            ht-msg-list.selected .col-right {
                width: 100%;
            }

            .message-box {
                padding: 4px;
                width: 100%;
                box-sizing: border-box;
                flex: 1;
            }

            .mobileOnly {display: none;}

            .doc-container {
                max-width: 50%;
            }

            .confirmPats {
                background: var(--app-secondary-color);
                position: relative;
                padding: 4px 8px;
                text-overflow: ellipsis;
                white-space: nowrap;
                overflow: hidden;
                border-radius: 4px;
                font-size: .8em;
                text-align: center;
                width: auto;
                box-shadow: var(--app-shadow-elevation-1);
                cursor: pointer;
            }

            #import-suggest {
                position: fixed;
                display: flex;
                top: calc(50vh + 97px);
                left: calc(16% + 20px);
                width: calc(80vw - 12px);
                height: auto;
                max-height: calc(100vh - 97px);
                transform: translateY(calc(-50% - 64px));
                justify-content: flex-end;
                background: #fff;
                padding: 8px;
                border: 1px solid var(--app-background-color-dark);
                box-shadow: var(--app-shadow-elevation-2);
                border-radius: 4px;
                z-index: 999;
                flex-direction: column;
                margin: 0 auto;
            }

            #import-suggest .twocol {
                display: grid;
                grid-template-columns: 50% 50%;
            }

            #import-suggest h5 {
                margin: 0 auto 4px auto;
                text-align: center;
            }

            #import-suggest .lab-details {
                flex-grow: 1;
                flex-direction: column !important;
                margin-bottom: 8px;
            }
            #import-suggest .lab-details .sheet {
                overflow-y: auto;
                background: var(--app-background-color-dark);
                border-radius: 4px;
                flex-grow: 1;
            }

            #import-suggest .scrollbox {
                height: 40vh; /* TODO : when labresult is done, "128px" */
                overflow-y: auto;
                background: var(--app-background-color-dark);
                border-radius: 4px;
                padding: 4px;
                display: flex;
                flex-direction: column;
                margin-bottom: 8px;
                box-sizing: border-box;
            }
            .scrollbox.labolist {
                margin-right: 8px; /* TODO : 8px when labresult done*/
                padding: 0 !important;
            }
            .scrollbox.patlist .checkbox-item {
                border-bottom: 1px solid var(--app-background-color-darker);
                padding: 4px;
            }
            .scrollbox.patlist .checkbox-item * div#checkbox.checked {
                background-color: var(--app-secondary-color-dark);
                border-color: var(--app-secondary-color-dark);
            }

            #import-suggest .line {
                display: flex;
                flex-direction: row;
                justify-content: flex-start;
                width: 100%;
            }
            #import-suggest .line > div.icon {
                display: flex;
                flex-direction: column;
                justify-content: space-around;
                width: 32px;
            }
            #import-suggest .line > div.grow {
                flex-grow: 1;
            }
            #import-suggest .save-line {
                justify-content: flex-end;
                min-height: 48px;
            }

            paper-listbox {
                background: transparent !important;
                padding: 0;
            }

            dynamic-doc {
                width: 100%;
            }

            .labolist .unassigned {
                line-height: 100%;
                display: flex;
                flex-direction: column;
                border-top: 1px solid var(--app-background-color-darker);
                text-align: left;
                padding: 8px;
            }
            .labolist .unassigned:first-child {
                border: none;
            }

            .labolist .unassigned .pat-name {
                font-weight: bold;
            }
            .labolist .unassigned iron-icon {
                width: 18px;
                margin-left: 4px;
            }
            .labolist .unassigned small {
                width: 100%;
                display: block;
            }
            .labolist .unassigned .labo-info {
                margin: 4px 0;
            }
            .labo-info .labo-name {}
            .labolist .unassigned .demand-date {
                text-align: right;
                font-size: .75em;
            }

            .pointer:hover,
            .pointer:focus,
            .pointer.iron-selected {
                background: var(--app-secondary-color);
                cursor: pointer;
                color: white;
                font-weight: initial;
            }
            .pointer.iron-selected {
                background: var(--app-secondary-color-dark);
            }

            paper-button.search-patients{
                background: var(--app-background-color-darker);
                margin: 4px;
            }
            paper-input.search-patients {
                flex-grow: 1;
            }
            iron-icon.search-patients {
                padding-top: 16px;
            }

            .wide-only {
                display: none;
            }

            .modal-button--cancel {
                background: transparent;
                color: black;
                border: 1px solid var(--app-background-color-dark);
            }
            
            @media screen and (max-width: 1336px) {
                .nomobile-wide {
                    display: none;
                }
                .wide-only {
                    display: block;
                }
                .msg-detail-btn {
                    min-width: 0;
                }
            }

            @media screen and (max-width: 1025px) {
                .mobileOnly {display: block;}
                .attached {
                    max-height: 25vh;
                    width: 100%;
                    overflow-y: auto;
                }

                #import-suggest {
                    left: 50vw;
                    transform: translateY(calc(-50% - 64px)) translateX(-50%);
                    width: 90vw;
                }

                .read-txt {
                    height: auto;
                    overflow-y: hidden;
                    min-height: 80px;
                }

                .action-buttons {
                    padding-left: 36px;
                }
            }

            @media screen and (max-width: 650px) {
                .noPortable {display: none !important;}
                #import-suggest {
                    max-height: 50vh;
                }

                #import-suggest .twocol {
                    display: flex;
                    flex-direction: column;
                }

                #import-suggest .scrollbox {
                    height: 128px;
                }

                #import-suggest .labolist {margin-right: 0;}
            }

            .m-r-5 {
                margin-right:5px;
            }

            .darkBlue {
                color:var(--dark-primary-color)!important;
            }

            .darkPink {
                color:#A02A7F!important;
            }

            .darkGreen {
                color:#41671e!important
            }

            .darkRed {
                                color:#a00000!important;
                            }

            h3.subject {
                margin:10px 0 10px 0;
            }

            .messageHeaders {
                color:var(--app-text-color-dark);
                font-size:14px
            }

            .singleHeaderLine {
                margin-bottom:5px;
            }

            .w20 {
                width:20px;
            }

            .h20 {
                height:20px;
            }

            .m-t-minus-2 {
                margin-top:-2px;
            }

            .clear {
                clear: both;
            }

            .m-t-20 {
                margin-top: 20px;
            }

            .close-button {
                margin: -12px 0 0 0;
                box-sizing: border-box;
                --paper-button-ink-color: var(--app-secondary-color);
                height: 40px !important;
                display: block;
                text-align: center;
                --paper-button: {
                    background: var(--app-secondary-color);
                    color: var(--app-text-color);
                    width: calc(100% - 48px);
                    margin: 0 auto;
                    font-size: 14px;
                    font-weight: bold;
                    text-transform: capitalize;
                };
                white-space: nowrap;
                text-overflow: ellipsis;
                overflow: hidden;
                max-width: 130px;
                text-transform: uppercase;
                font-weight: 700;
            }

            .closeIcon {
                margin:-3px 0 0 0;
                padding:0;
            }

            .visibilityHidden {
                                visibility:hidden;
                            }

            .fs9em {
                font-size:.9em;
            }

            .fs8em {
                font-size:.8em;
            }

            .fileSize {
                color:var(--app-primary-color-light);
                font-size:.9em;
                font-style:italic;
            }

            .cursorPointer{
                cursor:pointer;
            }

            #loadingContainer, #loadingContainerSmall {
                position:absolute;
                width: 100%;
                height: 100%;
                top: 0;left: 0;
                background-color: rgba(0,0,0,.3);
                z-index: 10;
                text-align: center;
            }

            #loadingContentContainer, #loadingContentContainerSmall {
                position:relative;
                width: 400px;
                min-height: 200px;
                background-color: #ffffff;
                padding:20px;
                border:3px solid var(--app-secondary-color);
                margin:40px auto 0 auto;
                text-align: center;
            }

            .loadingIcon {
                margin-right:5px;
                margin-top:-4px;
            }

            .loadingIcon.done {
                color: var(--app-secondary-color);
            }

            .mr5 {
                margin-right:5px;
            }

            .ml5 {
                margin-left:5px;
            }

            .smallIcon {
                width:16px;
                height:16px;
            }

            .textAlignCenter {
                text-align: center;
            }

            .modalDialog {
                height: 300px;
                width: 600px;
            }

            #annexAssignmentDialog {
                height: 100%;
                width: 100%;
                background-color: rgba(0,0,0,.3);
            }

            #annexAssignmentDialogContainer {
                padding:0px;
                margin:70px 10px 0 10px;
                height:calc(100% - 110px);
                background-color:#ffffff;
                box-shadow: var(--app-shadow-elevation-2)
            }

            .contentContainer {
                position:relative;
                margin:0;
                height:calc(100% - 96px);
                padding:20px;
            }

            #annexAssignmentLoadingContainer {
                position:absolute;
                width: 100%;
                height: 100%;
                top: 0;
                left: 0;
                background-color: rgba(255,255,255,.8);
                z-index: 10;
                text-align: center;
            }

            .f-r {
                float:right
            }

            #annexAssignmentSpinnerContainer{
                width:160px;
                height:160px;
                position:absolute;
                top: 50%;left: 50%;
                transform: translate(-50%, -50%);
            }

            .cursorPointer {
                cursor: pointer;
            }

            .dialogTabContent {
                padding:20px 20px 0 20px ;
                height: calc(100% - 130px);
                border:1px solid var(--app-background-color-darker)!important;
                overflow:auto;
            }

            .dialogTab {
                border-top:1px solid var(--app-background-color-darker);
                border-left:1px solid var(--app-background-color-darker);
                padding-left: 0;
                padding-right: 0;
            }

            .dialogTab:last-child {
                border-right:1px solid var(--app-background-color-darker);
            }

            .iron-selected {
                background-color:var(--app-background-color-dark)
            }

            .singleAssignment {
                margin-bottom:30px;
                border:1px dashed var(--app-background-color-darker);
                padding:15px 10px 10px 10px;
                background-color: var(--app-background-color);
                position:relative;
            }

            .singleAssignmentLine {
                margin-bottom:5px;
            }

            .singleAssignmentChecked {
                position:absolute;
                right:20px;
                top:20px;
                font-weight:700;
                color: #006C03;
            }

            .singleAssignmentDelete {
                position:absolute;
                bottom:15px;
                right:15px;
            }

            .modal-button-delete {
                background-color: #d40500;
                margin:0;
                color:#fff;
                font-weight: 700;
                text-transform: uppercase;
            }

            #positiveFeedback, #negativeFeedback {
                display: flex;
                position: fixed;
                top: 50vh;
                right: 0;
                transform: translate(100vw,-50%);
                z-index: 999;
                padding: 16px;
                border-radius: 4px 0 0 4px;
                transition: 1s ease-in;
                flex-flow: row wrap;
                align-items: center;
                justify-content: flex-start;
                background: rgba(0,0 ,0,.42);
                color: var(--app-text-color-light);
                box-shadow: 0 9px 12px 1px rgba(0,0,0,.14),
                0 3px 16px 2px rgba(0,0,0,.12),
                0 5px 6px 0 rgba(0,0,0,.2);
            }

            #positiveFeedback iron-icon, #negativeFeedback iron-icon{
                border-radius: 50%;
                padding: 2px;
                margin-right: 8px;
                box-sizing: border-box;
            }

            #positiveFeedback iron-icon{
                background: var(--app-status-color-ok);
            }

            #negativeFeedback iron-icon{
                background: var(--app-status-color-nok);
            }

            .showFeedbackMessage {
                animation: ribbonFeedbackAnimation 7.5s cubic-bezier(0.075, 0.82, 0.165, 1);
            }

            @keyframes ribbonFeedbackAnimation {
                0% {transform: translate(100vw,-50%);}
                10% {transform: translate(0,-50%);}
                88% {transform: translate(0,-50%);}
                100% {transform: translate(100vw,-50%);}
            }

		</style>



        <template is="dom-if" if="[[_isLoading]]">
            <div id="loadingContainer">
                <div id="loadingContentContainer">
                    <div style="max-width:100px; margin:0 auto"><ht-spinner class="spinner" alt="Loading..." active></ht-spinner></div>
                    <div id="loadingContent"></div>
                </div>
            </div>
        </template>



        <template is="dom-if" if="[[selectedMessage]]">
            <div id="main-details-panel" class="details-panel">



                <div class="action-buttons">
                    <div class="buttons">

                        <!-- Reply -->
                        <template is="dom-if" if="[[ehealthSession]]"><template is="dom-if" if="[[!_isSentbox(selectedMessage)]]"><template is="dom-if" if="[[!_isDeleted(selectedMessage)]]"><paper-button class="msg-detail-btn" on-tap="_takeAction" data-action="reply"><iron-icon icon="icons:reply" data-action="reply"></iron-icon> [[localize('reply','Reply',language)]]</paper-button></template></template></template>

                        <!-- Forward -->
                        <template is="dom-if" if="[[ehealthSession]]"><paper-button class="msg-detail-btn" on-tap="_takeAction" data-action="forward"><iron-icon icon="icons:reply" style="transform: scaleX(-1)" data-action="forward"></iron-icon> [[localize('ehb.forward','Forward',language)]]</paper-button></template>

                        <!-- Hide / unhide -->
                        <template is="dom-if" if="[[_isHidden(selectedMessage)]]"><paper-button class="msg-detail-btn" on-tap="_takeAction" data-action="hideUnhide"><iron-icon icon="visibility"  data-action="hideUnhide"></iron-icon> [[localize('ehb.unhideMessage','Unhide message',language)]]</paper-button></template>
                        <template is="dom-if" if="[[!_isHidden(selectedMessage)]]"><template is="dom-if" if="[[!_isDeleted(selectedMessage)]]"><paper-button class="msg-detail-btn" on-tap="_takeAction" data-action="hideUnhide"><iron-icon icon="visibility-off" data-action="hideUnhide"></iron-icon> [[localize('hid_msg','Hide message',language)]]</paper-button></template></template>

                        <!-- Delete / undelete / delete for ever -->
                        <div class="del-button">
                            <template is="dom-if" if="[[ehealthSession]]">
                                <template is="dom-if" if="[[_isDeleted(selectedMessage)]]">
                                    <paper-button class="msg-detail-btn" on-tap="_takeAction" data-action="deleteUndelete"><iron-icon icon="undo" data-action="deleteUndelete"></iron-icon> [[localize('restore','Restore',language)]]</paper-button>
                                    <paper-button class="msg-detail-btn" on-tap="_takeAction" data-action="deleteForEver"><iron-icon icon="delete-forever" data-action="deleteForEver"></iron-icon> [[localize('ehb.permaDelete','Delete for ever',language)]]</paper-button>
                                </template>
                                <template is="dom-if" if="[[!_isDeleted(selectedMessage)]]"><paper-button class="msg-detail-btn" on-tap="_takeAction" data-action="deleteUndelete"><iron-icon icon="delete" data-action="deleteUndelete"></iron-icon> [[localize('del','Delete',language)]]</paper-button></template>
                            </template>
                        </div>

                    </div>
                    <paper-button class="msg-detail-btn close-button" on-tap="_takeAction" data-action="close"><iron-icon icon="icons:close" data-action="close" class="closeIcon m-r-5"></iron-icon> [[localize('clo','Close',language)]]</paper-button>
                </div>



                <paper-card class="msg-detail-card" >
                    <h3 class="subject">[[selectedMessage.subject]]</h3>
                    <div class="messageHeaders">
                        <div class="singleHeaderLine"><iron-icon icon="icons:account-circle" class="m-r-5 darkBlue w20 m-t-minus-2"></iron-icon> [[selectedMessage.fromAddress]]</div>
                        <div class="singleHeaderLine"><iron-icon icon="icons:date-range" class="m-r-5 darkBlue w20 m-t-minus-2"></iron-icon> [[_msTstampToDDMMYYYY(selectedMessage.created)]]</div>
                        <template is="dom-if" if="[[_isImportant(selectedMessage)]]"><div class="singleHeaderLine"><iron-icon icon="warning" class="m-r-5 darkRed w20 m-t-minus-2"></iron-icon> [[localize('ehb.important','High importance',language)]]</div></template>
                        <template is="dom-repeat" items="[[_linkedPatientsBasedOnMessageSsinAndAnnexes]]" as="singlePatient"><div class="singleHeaderLine"><iron-icon icon$="[[_iconBySex(singlePatient.sex)]]" class$="m-r-5 [[_colorCssClassBySex(singlePatient.sex)]] w20 m-t-minus-2"></iron-icon> [[singlePatient.lastName]] [[singlePatient.firstName]] [[singlePatient.ssinOrBirthdate]]</div></template>
                        <template is="dom-repeat" items="[[_messageAttachments]]" as="singleAttachment">
                            <template is="dom-if" if="[[singleAttachment.attachmentUrl]]">
                                <div class="singleHeaderLine cursorPointer" data-attachmenturl="[[singleAttachment.attachmentUrl]]" on-tap="_downloadAttachment">
                                    <iron-icon icon="editor:attach-file" class="m-r-5 darkBlue w20 m-t-minus-2" data-attachmenturl="[[singleAttachment.attachmentUrl]]"></iron-icon>
                                    [[singleAttachment.filename]] <span class="fileSize" data-attachmenturl="[[singleAttachment.attachmentUrl]]">([[singleAttachment.size]])</span>
                                    <iron-icon icon="icons:file-download" class="darkBlue w20 m-t-minus-2" data-attachmenturl="[[singleAttachment.attachmentUrl]]"></iron-icon>
                                </div>
                            </template>
                        </template>

                    </div>
                </paper-card>
                <div class="clear m-t-20"></div>



                <template is="dom-repeat" items="[[documentsOfMessage]]">
                    <div class="layout-vertical annexe-card">
                        <dynamic-doc
                            id="[[item.id]]"
                            api="[[api]]"
                            i18n="[[i18n]]"
                            language="[[language]]"
                            resources="[[resources]]"
                            user="[[user]]"
                            patient="[[patient]]"
                            document-id="[[item.id]]"
                            title="[[item.label]]"
                            preview="true"
                            downloadable="true"
                            fullwidth="true"
                            is-body-text-of-email="[[_isEqual(item.documentLocation,'body')]]"
                            on-trigger-open-assignment-dialog="_toggleAssignmentDialog"
                        ></dynamic-doc>
                    </div>
                </template>



            </div>
        </template>



        <paper-dialog class="modalDialog" id="annexAssignmentDialog" always-on-top="true" no-cancel-on-outside-click no-cancel-on-esc-key>
            <div id="annexAssignmentDialogContainer">

                <h2 class="modal-title"><iron-icon icon="vaadin:clipboard-user" class="m-r-5"></iron-icon> [[localize('ehb.assignWindow.title','Assign selected annex to patient file',language)]] <iron-icon icon="icons:close" class="f-r cursorPointer" on-tap="_toggleAssignmentDialog"></iron-icon></h2>
                <div class="contentContainer">



                    <template is="dom-if" if="[[_assignmentDialogIsLoading]]"><div id="annexAssignmentLoadingContainer"><div id="annexAssignmentSpinnerContainer"><ht-spinner active></ht-spinner></div></div></template>



                    <paper-tabs selected="{{_assignmentActiveTab}}" attr-for-selected="name">
                        <paper-tab class="dialogTab" name="suggestion"><iron-icon icon="vaadin:clipboard-user" class="m-r-5 darkBlue w20 m-t-minus-2"></iron-icon> [[localize('ehb.assignmentSuggestions','Assignment suggestions',language)]]</paper-tab>
                        <paper-tab class="dialogTab" name="manual"><iron-icon icon="vaadin:pointer" class="m-r-5 darkBlue w20 m-t-minus-2"></iron-icon> [[localize('ehb.manualAssignment','Manual assignment',language)]] / [[localize('lowerSch','search',language)]]</paper-tab>
                        <paper-tab class="dialogTab" name="existing"><iron-icon icon="vaadin:bullets" class="m-r-5 darkBlue w20 m-t-minus-2"></iron-icon> [[localize('ehb.existingAssignments','Existing assignments',language)]]</paper-tab>
                        <!--<paper-tab class="dialogTab" name="newPatient"><iron-icon icon="vaadin:user-card" class="m-r-5 darkBlue w20 m-t-minus-2"></iron-icon> [[localize('ehb.assignToNewPatient','New patient',language)]]</paper-tab>-->
                    </paper-tabs>



                    <template is="dom-if" if="[[_isEqual(_assignmentActiveTab,'suggestion')]]">

                        <div class="dialogTabContent">
                            Assignation manuelle<br />
                            Regarder dans this._resolvedPatientsForSuggestedAssignments et y sous-traire les patients déjà assignés<br />
                            Auto-switch vers tab "assignations existantes" si tous les documents sont déjà assignés<br />
                            Si tous les documents sont déjà assignés, dire ici "vous avez déjà assigné tous les résultats"<br />
                            S'il reste des documents à assigner et que je n'ai pas trouvé de suggestions: le dire et simplement envoyer vers la recherche<br /><br />
                            Revoir metas message lors assignation document<br /><br />
                            Faire un LEVENSHTEIN ICI % import docs pas encore assignés
                        </div>

                        <div class="dialogButtons">
                            <paper-button class="modal-button modal-button--save" on-tap="_toggleAssignmentDialog"><iron-icon icon="icons:close" class="m-r-5" on-tap="_toggleAssignmentDialog"></iron-icon> [[localize('clo','Close',language)]]</paper-button>
                        </div>

                    </template>



                    <template is="dom-if" if="[[_isEqual(_assignmentActiveTab,'manual')]]">

                        <div class="dialogTabContent">
                            Recherche un patient<br />
                            Afficher recherche de patients + grid avec DP + radio box / icone pour assigner à CE patient<br />
                            SOUS-TRAIRE de la recherche tous les pats pour lesquels j'ai déjà assigné CE document<br />
                            Revoir metas message lors assignation document
                        </div>

                        <div class="dialogButtons">
                            <paper-button class="modal-button modal-button--save" on-tap="_toggleAssignmentDialog"><iron-icon icon="icons:close" class="m-r-5" on-tap="_toggleAssignmentDialog"></iron-icon> [[localize('clo','Close',language)]]</paper-button>
                        </div>

                    </template>



                    <template is="dom-if" if="[[_isEqual(_assignmentActiveTab,'existing')]]">

                        <div class="dialogTabContent">
                            <template is="dom-repeat" items="[[_alreadyAssignedDocuments]]" as="existingAssignment">
                                <div class="singleAssignment">
                                    <div class="singleAssignmentLine"><iron-icon icon$="[[_iconBySex(existingAssignment.patientData.sex)]]" class$="m-r-5 [[_colorCssClassBySex(existingAssignment.patientData.sex)]] w20 m-t-minus-2"></iron-icon> <b>[[existingAssignment.patientData.lastName]] [[existingAssignment.patientData.firstName]]</b></div>
                                    <div class="singleAssignmentLine"><iron-icon icon="vaadin:user-card" class="m-r-5 w20 m-t-minus-2"></iron-icon> [[localize('ssinPatVerbose','National identification number',language)]]: [[_formatSsinNumber(existingAssignment.patientData.ssin)]]</div>
                                    <div class="singleAssignmentLine"><iron-icon icon="social:cake" class="m-r-5 w20 m-t-minus-2"></iron-icon> [[localize('birthDate','Birth date',language)]]: [[existingAssignment.patientData.dateOfBirthHr]]</div>
                                    <div class="singleAssignmentLine"><iron-icon icon="icons:home" class="m-r-5 w20 m-t-minus-2"></iron-icon> [[localize('postalAddress','Address',language)]]: [[existingAssignment.patientData.address.street]] [[existingAssignment.patientData.address.houseNumber]] [[existingAssignment.patientData.address.postboxNumber]]</div>
                                    <div class="singleAssignmentLine"><iron-icon icon="social:location-city" class="m-r-5 w20 m-t-minus-2"></iron-icon> [[localize('zipHyphenCity','ZIP - City',language)]]: [[existingAssignment.patientData.address.postalCode]] [[existingAssignment.patientData.address.city]]</div>
                                    <div class="singleAssignmentLine"><iron-icon icon="vaadin:calendar-clock" class="m-r-5 w20 m-t-minus-2 darkBlue"></iron-icon> [[localize('assignmentDate','Assignment date',language)]]: [[existingAssignment.createdHr]]</div>
                                    <div class="singleAssignmentChecked"><iron-icon icon="icons:check-circle" class="m-r-5 w20 m-t-minus-2"></iron-icon> [[localize('documentAssigned','Document assigned',language)]]</div>
                                    <div class="singleAssignmentDelete"><paper-button class="modal-button modal-button-delete" on-tap="_deleteAssignment" data-contact-id$="[[existingAssignment.contactId]]"><iron-icon icon="icons:delete-forever" class="m-r-5 w20 m-t-minus-2" data-contact-id$="[[existingAssignment.contactId]]"></iron-icon> [[localize('deleteAssignment','Delete assignment',language)]]</paper-button></div>
                                </div>
                            </template>
                        </div>

                        <div class="dialogButtons">
                            <paper-button class="modal-button modal-button--save" on-tap="_toggleAssignmentDialog"><iron-icon icon="icons:close" class="m-r-5" on-tap="_toggleAssignmentDialog"></iron-icon> [[localize('clo','Close',language)]]</paper-button>
                        </div>

                    </template>



                    <!--
                    <template is="dom-if" if="[[_isEqual(_assignmentActiveTab,'newPatient')]]">

                        <div class="dialogTabContent">
                            Assigner à un nouveau patient
                            <br /><br />Revoir metas message on the fly lors assignation document
                        </div>

                        <div class="dialogButtons">
                            <paper-button class="modal-button modal-button--cancel" dialog-dismiss>[[localize('can','Cancel',language)]]</paper-button>
                            <paper-button class="modal-button modal-button--save" dialog-confirm autofocus on-tap="validateMedications">[[localize('valid','Validate',language)]]</paper-button>
                        </div>

                    </template>
                    -->



                    <div id="positiveFeedback"><iron-icon icon="check"></iron-icon> [[localize('assignmentSuccessfullyUpdated','Assignment successfully updated',language)]]</div>
                    <div id="negativeFeedback"><iron-icon icon="clear"></iron-icon> [[localize('assignmentNotSuccessfullyUpdated','Assignment could not be updated',language)]]</div>



                </div>

            </div>
        </paper-dialog>



	</template>



	<script>

        import _ from 'lodash/lodash';
        import moment from 'moment/src/moment';

        class HtMsgDetail extends Polymer.TkLocalizerMixin(Polymer.Element) {

            static get is() {
                return 'ht-msg-detail';
            }

            static get properties() {
                return {
                    api: {
                        type: Object,
                        noReset: true
                    },
                    user: {
                        type: Object,
                        noReset: true
                    },
                    ehealthSession: {
                        type: Boolean,
                        value: false,
                        noReset: true
                    },
                    i18n: {
                        Type: Object,
                        value: function () {
                            moment.locale('fr');
                            const res = {
                                monthNames: moment.months(),
                                weekdays: moment.weekdays(),
                                weekdaysShort: moment.weekdaysShort(),
                                firstDayOfWeek: moment.localeData().firstDayOfWeek(),
                                week: 'Semaine',
                                calendar: 'Calendrier',
                                clear: 'Clear',
                                today: 'Aujourd\'hui',
                                cancel: 'Annuler',
                                formatDate: function (d) {
                                    //return moment(d).format(moment.localeData().longDateFormat('L'))
                                    return moment(d).format('DD/MM/YYYY');
                                },
                                parseDate: function (s) {
                                    return moment(s, 'DD/MM/YYYY').toDate();
                                },
                                formatTitle: function (monthName, fullYear) {
                                    return monthName + ' ' + fullYear;
                                }
                            };
                            return res;
                        },
                        noReset: true
                    },
                    selectedMessage: {
                        type: Object,
                        value: {}
                    },
                    _isLoading: {
                        type: Boolean,
                        value: false,
                        observer: '_loadingStatusChanged'
                    },
                    _loadingMessages: {
                        type: Array,
                        value: () => []
                    },
                    _linkedPatientsBasedOnMessageSsinAndAnnexes:{
                        type: Array,
                        value: () => []
                    },
                    processLock: {
                        type: Boolean,
                        value: false,
                        noReset: true
                    },
                    documentsOfMessage:{
                        type: Array,
                        value: () => []
                    },
                    _messageAttachments:{
                        type: Array,
                        value: () => []
                    },
                    _assignmentActiveTab:{
                        type: String,
                        value: "suggestion"
                    },
                    _assignmentDialogIsLoading:{
                        type: Boolean,
                        value: false
                    },
                    _assignmentDialogIsOpened:{
                        type: Boolean,
                        value: false
                    },
                    _alreadyAssignedDocuments: {
                        type: Array,
                        value: () => []
                    },
                    _resolvedPatientsForSuggestedAssignments: {
                        type: Array,
                        value: () => []
                    },
                    _assignmentCallBack: {
                        type: Object,
                        value: {},
                        noReset: true
                    }
                };
            }

            static get observers() {
                return [
                    '_setIsConnectedToEhbox(api.tokenId)',
                    '_loadMessageDetails(selectedMessage)',
                ];
            }

            constructor() {
                super();
            }

            ready() {
                super.ready();
                document.addEventListener('keyup',this._handleShortcutKeys.bind(this))
            }

            _setIsConnectedToEhbox() {
                this.set("ehealthSession", !!this.api.tokenId)
            }

            _isEqual(a, b) {
                return !!(a===b)
            }

            _msTstampToDDMMYYYY(msTstamp) {
                return parseInt(msTstamp) ? this.api.moment(parseInt(msTstamp)).format('DD/MM/YYYY') : ""
            }

            _isDeleted(inputData) {
                return !!_.trim(_.get(inputData,"transportGuid","")).startsWith("BIN")
            }

            _isHidden(inputData) {
                return !!(_.get(inputData,"status",0)&(1<<14))
            }

            _isSentbox(inputData) {
                return !!_.trim(_.get(inputData,"transportGuid","")).startsWith("SENT")
            }

            _resetComponentData(){

                const componentProperties = HtMsgDetail.properties
                Object.keys(componentProperties).forEach(k => { if (!_.get(componentProperties[k],"noReset", false)) { this.set(k, (typeof componentProperties[k].value === 'function' ? componentProperties[k].value() : (componentProperties[k].value || null))) }})

                this.$['positiveFeedback'] && this.$['positiveFeedback'].classList && this.$['positiveFeedback'].classList.remove('showFeedbackMessage')
                this.$['negativeFeedback'] && this.$['negativeFeedback'].classList && this.$['negativeFeedback'].classList.remove('showFeedbackMessage')

            }

            _getPatientDataBySsin(selectedMessage) {
                const patientSsin = _.trim(_.get(selectedMessage,"metas.patientSsin",""))
                return !_.trim(patientSsin) ?
                    Promise.resolve() :
                    this.api.patient().findByNameBirthSsinAutoWithUser(_.get(this,"user",{}), _.trim(_.get(this,"user.healthcarePartyId",null)), _.trim(patientSsin), null, null, 100)
                        .then(foundPatientsBasedOnSsin => _
                            .chain(_.get(foundPatientsBasedOnSsin,"rows",[]))
                            .filter(i=>!!_.get(i,"active",false) && _.trim(_.get(i,"ssin","")) === _.trim(patientSsin))
                            .orderBy(['modified'],['desc'])
                            .head()
                            .value()
                        )
                        .catch(e=>{console.log("ERROR with findByNameBirthSsinAutoWithUser: ", e); return Promise.resolve();})
            }

            _takeAction(e, takeActionAdditionalParameters={}) {
                const actionToTake = typeof e === "string" ? _.trim(e) : _.get(_.filter(_.get(e,"path",[]), nodePath=> !!_.trim(_.get(nodePath,"dataset.action",""))),"[0].dataset.action","")
                const additionalParameters = _.merge({}, { documentsOfMessage:_.get(this,"documentsOfMessage",[]), _linkedPatientsBasedOnMessageSsinAndAnnexes:_.get(this,"_linkedPatientsBasedOnMessageSsinAndAnnexes",[]), _messageAttachments:_.get(this,"_messageAttachments",[]) }, takeActionAdditionalParameters)
                return !_.trim(_.get(this,"selectedMessage.id", "")) || !_.trim(actionToTake) ? false : this.dispatchEvent(new CustomEvent('carry-out-action', {composed: true, bubbles: true, detail: {action:_.trim(actionToTake), message:_.get(this,"selectedMessage",{}),additionalParameters:additionalParameters}}));
            }

            _isImportant(m) {
                return ((m.status & (1 << 2)) !== 0)
            }

            _hasAnnex(m) {
                return ((m.status & (1 << 4)) !== 0)
            }

            _iconBySex(inputData) {
                return (inputData === "F" || inputData === "W") ? "vaadin:female" : "vaadin:male"
            }

            _colorCssClassBySex(inputData) {
                return (inputData === "F" || inputData === "W") ? "darkPink" : "darkBlue"
            }

            _downloadAttachment(e) {

                const downloadUrl = _.get(_.filter(_.get(e,"path",[]), nodePath=> !!_.trim(_.get(nodePath,"dataAttachmenturl",""))),"[0].dataAttachmenturl","")
                if(!_.trim(downloadUrl)) return

                try {
                    const linkObject = _.merge(document.createElement("a"),{ style: "display: none", href: downloadUrl })
                    this.appendChild( linkObject ) && linkObject.click() && window.URL.revokeObjectURL(downloadUrl);
                } catch(e) { window.open(_.trim(downloadUrl)) }

            }

            _loadingStatusChanged() {
                if(!this._isLoading) this._resetLoadingMessage();
            }

            _resetLoadingMessage() {
                this._loadingMessages = [];
            }

            _setLoadingMessage( messageData ) {
                setTimeout(()=> {
                    if (messageData.updateLastMessage) this._loadingMessages.pop();
                    this._loadingMessages.push(messageData);
                    let loadingContentTarget = this.shadowRoot.querySelectorAll('#loadingContent')[0];
                    if (loadingContentTarget) { loadingContentTarget.innerHTML = ''; _.each(this._loadingMessages, (v) => { loadingContentTarget.innerHTML += "<p><iron-icon icon='" + v.icon + "' class='" + (v.done ? "loadingIcon done" : "loadingIcon") + "'></iron-icon>" + v.message + "</p>"; }); }
                },100)
            }

            _toggleProcessingPopup( inputMessage="" ) {
                if(!_.get(this,"_isLoading",false)) {
                    this._resetLoadingMessage();
                    this.set('_isLoading', true );
                    this._setLoadingMessage({ message: _.trim(inputMessage) ? _.trim(inputMessage) : this.localize('ongoingProcess',this.language), icon:"arrow-forward"});
                } else {
                    this.set('_isLoading', false );
                }
            }

            _handleShortcutKeys(e) {

                const isActive = !!_.size(_.get(this,"selectedMessage",{}))
                const isInInput = ["INPUT", "SELECT", "TEXTAREA"].indexOf(_.get(e,"target.nodeName","")) !== -1
                const assignmentDialogIsOpened = !!_.get(this,"_assignmentDialogIsOpened",false)

                if(!isActive || isInInput) return

                const pressedKey = _.trim(_.get(e,"key","")).toLocaleLowerCase();
                const message = _.get(this,"selectedMessage",{})
                const ehealthSession = !!this.ehealthSession
                const isSentBox = !!this._isSentbox(message)
                const isDeleted = !!this._isDeleted(message)

                if(!!assignmentDialogIsOpened && pressedKey === "escape") this._toggleAssignmentDialog()
                if(!!assignmentDialogIsOpened) return

                if(pressedKey === "escape") this._takeAction("close")
                if((pressedKey === "c" || pressedKey === "h" || pressedKey === "m")) this._takeAction("hideUnhide")
                if(!!ehealthSession && !isSentBox && !isDeleted && pressedKey === "r") this._takeAction("reply")
                if(!!ehealthSession && (pressedKey === "f" || pressedKey === "t")) this._takeAction("forward")
                if(!!ehealthSession && (pressedKey === "d" || pressedKey === "s" || pressedKey === "delete")) this._takeAction("deleteUndelete")

            }

            _formatSsinNumber(inputData) {
                return this.api.formatSsinNumber(_.trim(inputData))
            }

            _deleteAssignment(e) {

                const contactId = _.trim(_.get(_.filter(_.get(e,"path",[]), nodePath=> !!_.trim(_.get(nodePath,"dataset.contactId",""))),"[0].dataset.contactId",""))
                if(!_.trim(contactId)) return;

                this.set("_assignmentCallBack", {
                    action: "deleteAssignment",
                    activeTab: _.trim(_.get(this,"_assignmentActiveTab","")),
                    contactId: contactId,
                    documentId: _.trim(_.get(_.find(_.get(this,"_alreadyAssignedDocuments",[]), {contactId:contactId}),"documentId")),
                    patientId: _.trim(_.get(_.find(_.get(this,"_alreadyAssignedDocuments",[]), {contactId:contactId}),"patientId")),
                })

                this.set("_assignmentDialogIsLoading", true)
                this._takeAction("deleteAssignment",{contactId:contactId, dontCloseReadMessageComponent:true})

            }

            _loadMessageDetails(selectedMessage) {



                const prom = Promise.resolve()
                let patientDetailsBasedOnSsin = false



                if(!!_.get(this, "processLock", false)) return prom;
                this.set("processLock", true)

                this._resetComponentData();
                if(!!_.size(selectedMessage)) this.set("selectedMessage", selectedMessage);
                this.set("processLock", false)

                if(!_.size(selectedMessage)) return prom
                this._toggleProcessingPopup()



                const assignmentCallBack = _.get(this,"_assignmentCallBack",{})
                if(!!_.size(assignmentCallBack)) {
                    this.set("_assignmentDialogIsLoading", true)
                    this.set("_assignmentActiveTab", _.trim(_.get(assignmentCallBack,"activeTab","suggestion")))
                    this.set("_assignmentCallBack", {})
                }

                return this._getPatientDataBySsin(selectedMessage)
                    .then(x => patientDetailsBasedOnSsin = x)
                    .then(()=> !_.trim(_.get(selectedMessage,"id","")) ? prom : this.api.document().findByMessage(_.get(this,"user.healthcarePartyId",""), selectedMessage).catch(e=>{console.log("ERROR with findByMessage: ", e); return prom;}))
                    .then(documentsOfMessage => !_.size(documentsOfMessage) ? prom : Promise.all(_.compact(_.filter(documentsOfMessage,d=>!!_.trim(_.get(d,"attachmentId",""))&&!!_.trim(_.get(d,"secretForeignKeys","")))).map(singleDocument => this.api.crypto().extractKeysFromDelegationsForHcpHierarchy(_.get(this,"user.healthcarePartyId", null), _.trim(_.get(singleDocument,"id","")), _.size(_.get(singleDocument,"encryptionKeys",[])) ? _.get(singleDocument,"encryptionKeys",[]) : _.get(singleDocument,"delegations",[]))
                        .then(({extractedKeys: enckeys}) => this.api.beresultimport().canHandle(_.trim(_.get(singleDocument,"id","")), enckeys.join(',')).catch(e=>{console.log("ERROR with canHandle: ", e); return prom;})
                            .then(canHandle => !!canHandle ? this.api.beresultimport().getInfos(_.trim(_.get(singleDocument,"id","")), true, null, enckeys.join(',')).catch(e=>{console.log("ERROR with getInfos: ", e); return prom;}) : prom)
                            .then(beResultImportInfos => !beResultImportInfos ? prom : _.compact(_.map(beResultImportInfos, singleBeResultImportInfo => { return _.merge(singleBeResultImportInfo, {
                                codes: _.get(singleBeResultImportInfo,"codes[0]",{}),
                                lastName: _.map( _.trim(_.get(singleBeResultImportInfo, "lastName", "")).split(" "),i=> _.capitalize(i)).join(" "),
                                firstName: _.map( _.trim(_.get(singleBeResultImportInfo, "firstName", "")).split(" "),i=> _.capitalize(i)).join(" "),
                                dateOfBirthHr: (_.parseInt(_.trim(_.get(singleBeResultImportInfo,"dateOfBirth",""))) ? moment(_.trim(_.get(singleBeResultImportInfo,"dateOfBirth",""))).format("DD/MM/YYYY") : ""),
                                complete: !!_.get(singleBeResultImportInfo,"complete",""),
                                demandDate: parseInt(_.get(singleBeResultImportInfo,"demandDate",0)),
                                demandDateHr: moment(_.get(singleBeResultImportInfo,"demandDate",undefined)).format("DD/MM/YYYY")
                            })})))
                            .then(documentsInfos => ({singleDocument,documentsInfos}))
                            .then(({singleDocument,documentsInfos})=>!!_.trim(_.get(singleDocument,"id","")) && _.trim(_.get(singleDocument,"attachmentId","")) ? this.api.document().getAttachment(_.trim(_.get(singleDocument,"id","")), _.trim(_.get(singleDocument,"attachmentId","")), enckeys.join(',')).then(decryptedContent=>({singleDocument,documentsInfos,decryptedContent})).catch(e=>{console.log("ERROR with getAttachment: ",e); return ({singleDocument,documentsInfos});}) : ({singleDocument,documentsInfos}))
                            .then(({singleDocument,documentsInfos,decryptedContent})=>{
                                const foundExtension = _.trim(_.get(singleDocument,"name","")).split(".").pop()
                                const fileExtension = _.trim(_.get( _.compact(_.map(this.api.document().utiExts, (v,k)=>_.trim(v).toLowerCase() ===_.trim(_.get(singleDocument,"mainUti","")).toLowerCase()?k:false)), "[0]", ( _.trim(_.get(singleDocument,"name","")).indexOf(".") > -1 && _.trim(foundExtension).length<5 && _.trim(foundExtension).length>2 ? foundExtension : "" ))).toLowerCase()
                                const attachmentSize = _.get((typeof decryptedContent === "string" ? this.api.crypto().utils.text2ua(decryptedContent) : decryptedContent),"byteLength",0)
                                const attachmentSizePow = attachmentSize > (1024**2) ? 2 : attachmentSize > 1024 ? 1 : 0
                                return !_.trim(decryptedContent) ? false :  _.merge(singleDocument,{
                                    docInfo:documentsInfos||[],
                                    attachmentInfos:{
                                        filename: _.kebabCase(_.trim(_.get(singleDocument,"name","")).replace("."+foundExtension,"")) + "." + fileExtension,
                                        fileExtension: fileExtension,
                                        size: this.api._powRoundFloatByPrecision( attachmentSize / (1024**attachmentSizePow) ,2) + " " + _.trim(attachmentSizePow === 2 ? "Mb" : attachmentSizePow === 1 ? "Kb" : "Bytes"),
                                        attachmentUrl: _.trim(this.api.document().getAttachmentUrl(_.trim(_.get(singleDocument, "id","")), _.trim(_.get(singleDocument, "attachmentId","")), enckeys, this.api.sessionId)),
                                        decryptedContent: decryptedContent,
                                        mimeType: _.trim(this.api.document().mimeType(_.trim(_.get(singleDocument,"mainUti","")))) ? _.trim(this.api.document().mimeType(_.trim(_.get(singleDocument,"mainUti","")))) : "text/plain",
                                        uniqueId: _.uniqueId(_.trim(_.get(singleDocument,"id","")) + "-"),
                                        documentId: _.trim(_.get(singleDocument, "id",""))
                                    }
                                })
                            })
                        )
                        .catch(e=>{console.log("ERROR with extractKeysFromDelegationsForHcpHierarchy: ", e); return singleDocument;})
                    )))
                    .then(documentsOfMessage => this.set("documentsOfMessage", !!_.size(documentsOfMessage) ? _.compact(_.orderBy(documentsOfMessage, d => _.trim(_.get(d,"documentLocation","annex")) === "body" ? "" : _.get(d,"id",_.uniqueId()))) : []))
                    .catch(e=>console.log("ERROR with _loadMessageDetails: ", e))
                    .finally(()=>{
                        this.set("_linkedPatientsBasedOnMessageSsinAndAnnexes", _.uniqBy(_.compact(
                            _.compact(_.concat( [patientDetailsBasedOnSsin], _.flatMap(_.map(_.get(this,"documentsOfMessage",[]), singleDoc => _.map(_.get(singleDoc,"docInfo",[]), x=>x))))).map(pat => { return {
                                sex: _.trim(_.get(pat, "sex", "")).toUpperCase(),
                                lastName: _.map(_.trim(_.get(pat, "lastName", "")).split(" "), i => _.capitalize(i)).join(" "),
                                firstName: _.map(_.trim(_.get(pat, "firstName", "")).split(" "), i => _.capitalize(i)).join(" "),
                                ssinOrBirthdate: (
                                    !!_.trim(_.get(pat, "ssin", "")) ? "(" + this.localize('ssinPatVerbose', 'Numéro de registre national', this.language) + ": " + this.api.formatSsinNumber(_.trim(_.get(pat, "ssin", ""))) + ")" :
                                    !!_.trim(_.get(pat, "dateOfBirth", "")) ? "(" + this.localize('birthDate', 'Birthdate', this.language) + ": " + moment(_.trim(_.get(pat, "dateOfBirth", 0)), "YYYYMMDD").format('DD/MM/YYYY') + ")" :
                                    ""
                                )
                            }})),"ssinOrBirthdate")
                        )
                        this.set("_messageAttachments", _.orderBy(_.compact(_.map(_.get(this,"documentsOfMessage",[]).filter(d=>_.trim(_.get(d,"documentLocation",""))==="annex"), singleDoc => _.get(singleDoc,"attachmentInfos",{}))), ['filename','size'],['asc','asc']))
                        this._toggleProcessingPopup()
                        return _.trim(_.get(assignmentCallBack,"action","")) === "deleteAssignment" ? this._toggleAssignmentDialog({assignmentCallBack:assignmentCallBack}) : prom
                    })

            }

            _toggleAssignmentDialog(e) {

                const assignmentCallBack = _.get(e,"assignmentCallBack",{})

                let prom = Promise.resolve();
                const documentId = !!_.size(assignmentCallBack) ? _.trim(_.get(assignmentCallBack,"documentId","")) : _.trim(_.get(e,"detail.documentId",""))
                const isOpened = !!_.get(this,"_assignmentDialogIsOpened",false)

                if(!isOpened && !_.trim(documentId)) return prom;
                if(!!isOpened) { this.set("_assignmentDialogIsOpened", false); this.set("_assignmentDialogIsLoading", false); this.$["positiveFeedback"].classList.remove('showFeedbackMessage'); this.$["negativeFeedback"].classList.remove('showFeedbackMessage'); this.$['annexAssignmentDialog'].close(); return prom; }
                if(!isOpened && _.trim(documentId)) { this.set("_assignmentDialogIsOpened", true); this.set("_assignmentDialogIsLoading", true); this.$['annexAssignmentDialog'].open(); }

                const selectedMessage =  _.get(this,"selectedMessage",{})
                const currentDocument = _.find(_.get(this,"documentsOfMessage",[]), {id:documentId})
                const docInfosOfCurrentDocument = _.get(currentDocument, "docInfo",[])
                const patInfosOfSelectedDocument = _.filter(_.get(selectedMessage,"patientInfos",[]), {documentId:documentId})

                let patientsToResolve = _.map(docInfosOfCurrentDocument, x => { return { lastName: _.get(x,"lastName",""), firstName: _.get(x,"firstName",""), dateOfBirth: _.get(x,"dateOfBirth",""), ssin: _.get(x,"ssin",""), } })
                patientsToResolve = _.compact(_.concat(patientsToResolve, _.map(patInfosOfSelectedDocument, x => { return { lastName: _.get(x,"patientData.lastName",""), firstName: _.get(x,"patientData.firstName",""), dateOfBirth: _.get(x,"patientData.dateOfBirth",""), ssin: _.get(x,"patientData.ssin",""), id: _.get(x,"patientData.id",""), } })))
                patientsToResolve = _.uniqBy(patientsToResolve, x => [ _.get(x,"id",""), _.get(x,"ssin",""), _.get(x,"dateOfBirth",""), _.get(x,"lastName",""),  _.get(x,"firstName","")].join() )

                _.map(patientsToResolve, singlePatientToResolve => {
                    prom = prom.then(promisesCarrier => !!_.trim(_.get(singlePatientToResolve,"id","")) ?
                        this.api.patient().getPatientWithUser(_.get(this,"user",{}),_.trim(_.get(singlePatientToResolve,"id",""))).then(foundPatient=>_.concat(promisesCarrier, foundPatient)).catch(e=>{console.log("ERROR with getPatientWithUser: ", e); return promisesCarrier;}) :
                        !!_.trim(_.get(singlePatientToResolve,"ssin","")) ?
                            this.api.patient().findByNameBirthSsinAutoWithUser(_.get(this,"user",{}), _.trim(_.get(this,"user.healthcarePartyId","")), _.trim(_.get(singlePatientToResolve,"ssin","")), null, null, 10).then(({rows})=>_.concat(promisesCarrier, rows)).catch(e=>{console.log("ERROR with findByNameBirthSsinAutoWithUser (by ssin): ", e); return promisesCarrier;}) :

                            // FABIEN: remplacer ceci par du levensthein
                            this.api.patient().fuzzySearchWithUser(_.get(this,"user",{}),_.trim(_.get(singlePatientToResolve,"firstName","")), _.trim(_.get(singlePatientToResolve,"lastName","")), _.trim(_.get(singlePatientToResolve,"dateOfBirth",""))).then(foundPatient=>_.concat(promisesCarrier, foundPatient)).catch(e=>{console.log("ERROR with fuzzySearchWithUser: ", e); return promisesCarrier;})
                    )
                })

                return prom
                    .then(resolvedPatients =>  this.set("_resolvedPatientsForSuggestedAssignments", _.uniqBy(_.compact(resolvedPatients), 'id')))
                    .then(()=>{
                        const alreadyAssignedDocuments = _.compact(_.filter(patInfosOfSelectedDocument, {isAssigned:true}))
                        return this.api.contact().getContactsWithUser(_.get(this,"user",{}),{ids:_.map(alreadyAssignedDocuments,x=>_.trim(_.get(x,"contactId","")))})
                            .then(foundContacts => _.map(alreadyAssignedDocuments, aad => {
                                const contactCreatedOn = _.get(_.find(foundContacts, {id:_.trim(_.get(aad,"contactId",""))}), "created", null)
                                return _.merge({}, aad, {
                                    created: contactCreatedOn,
                                    createdHr: moment(contactCreatedOn).format("DD/MM/YYYY - HH:mm:ss")
                                })
                            }))
                            .catch(e=>{console.log("ERROR with getContactsWithUser: ", e); return alreadyAssignedDocuments;})
                    })
                    .then(alreadyAssignedDocuments => this.set("_alreadyAssignedDocuments", alreadyAssignedDocuments))
                    .catch(e=>console.log("ERROR with _toggleAssignmentDialog: ", e))
                    .finally(()=>{

                        console.log("[_toggleAssignmentDialog]");
                        console.log("selectedMessage", selectedMessage);
                        console.log("currentDocument", currentDocument);
                        console.log("patInfosOfSelectedDocument", patInfosOfSelectedDocument);
                        console.log("patientsToResolve", patientsToResolve);
                        console.log("_resolvedPatientsForSuggestedAssignments", this._resolvedPatientsForSuggestedAssignments);
                        console.log("alreadyAssignedDocuments", this._alreadyAssignedDocuments);

                        if(!!_.size(assignmentCallBack)) {
                            setTimeout(() => { this.$["positiveFeedback"].classList.add('showFeedbackMessage'); },100);
                            setTimeout(() => { this.$["positiveFeedback"].classList.remove('showFeedbackMessage'); },8000);
                        }
                        this.set("_assignmentDialogIsLoading", false)
                        return prom

                    })

            }





            // Créer accès log après assignation lab résult
            //
            // this.api.accesslog().createAccessLog(new AccessLogDto({
            //     id: this.api.crypto().randomUuid(),
            //     patientId: patientId,
            //     user: user.id,
            //     date: +new Date(),
            //     accessType: 'USER_ACCESS'
            // }));





















            
            



            // Fabien: revoir fiolle

            // _assignResultToSelected(selMsg,targets,document,docInfo) {
            //     if (docInfo && docInfo.formatedDemandDate) delete docInfo.formatedDemandDate
            //     if (selMsg && selMsg.unassignedResults && selMsg.unassignedResults.length && targets && docInfo && document) {
            //         targets.map(thisPat=>{
            //             // console.log('_assignResultToSelected',selMsg, targets, docInfo, document,thisPat)
            //             this.api.contact().newInstance(this.user, thisPat, {
            //                 created: _.get(selMsg,"created", new Date().getTime()),
            //                 modified: _.get(selMsg,"created", new Date().getTime()),
            //                 author: this.user.id,
            //                 responsible: this.user.healthcarePartyId,
            //                 openingDate: moment(docInfo.demandDate).format('YYYYMMDDHHmmss') || '',
            //                 closingDate: moment().format('YYYYMMDDHHmmss') || '',
            //                 encounterType: {type: docInfo.codes.type, version: docInfo.codes.version, code: docInfo.codes.code},
            //                 descr: docInfo.labo,
            //                 subContacts: []
            //             }).then(c => {
            //                 c.services.push({
            //                     id: this.api.crypto().randomUuid(),
            //                     label: 'labResult',
            //                     valueDate: parseInt(moment().format('YYYYMMDDHHmmss')),
            //                     content: _.fromPairs([[this.language, {stringValue:docInfo.labo}]]),
            //                     tags:[{type:'CD-TRANSACTION', code:'labresult'}]
            //                 })
            //                 return this.api.contact().createContactWithUser(this.user, c)
            //             }).then(c => {
            //                 return this.api.form().newInstance(this.user, thisPat, {
            //                     contactId: c.id,
            //                     // cryptedForeignKeys: thisPat.cryptedForeignKeys,
            //                     descr: "Lab " + new Date().getTime(),
            //                 }).then(f => {
            //                     console.log('should do Import',f)
            //                     return this.api.form().createForm(f).then(f =>
            //                         this.api.hcparty().getHealthcareParty(this.user.healthcarePartyId).then(hcp =>
            //                             this.api.crypto()
            //                                 .extractKeysFromDelegationsForHcpHierarchy(hcp.id, document.id, _.size(document.encryptionKeys) ? document.encryptionKeys : document.delegations)
            //                                 .then(({extractedKeys: enckeys}) => this.api.beresultimport().doImport(document.id, hcp.id, hcp.languages.find(e => !!e) || "en", docInfo.protocol, f.id, null, enckeys.join(','), c))
            //                         )
            //                     )
            //                 })
            //             }).then(c => {
            //                 const idx = (this.unassignedResults || []).indexOf(docInfo.protocol)
            //                 this.splice('unassignedResults', idx)
            //
            //                 let tempAssign = _.clone(this.assignedResults)
            //                 tempAssign[c.id] = docInfo.protocol
            //                 this.set('assignedResults',tempAssign)
            //
            //                 selMsg.unassignedResults = this.unassignedResults
            //                 selMsg.assignedResults = tempAssign
            //
            //                 return selMsg
            //             }).then(selMsg=>{
            //                 return this.api.message().modifyMessage(selMsg).then(msg => {
            //                     _.assign(this.selectedMessage, msg)
            //                     if (msg.unassignedResults.length === 0) {
            //                         this.closeSuggestions()
            //                     } else {
            //                         this.set("selectedMessage", msg)
            //                     }
            //                     return Promise.resolve()
            //                 });
            //             })
            //             .catch(err => {
            //                 console.warn("error:" + err)
            //             })
            //         }) // map end
            //     } else {
            //         console.warn('_assignResultToSelected missing attribute',selMsg,targets,document,docInfo)
            //     }
            // }

            // _assignToPat() {
            //     if (this.selectedMessage && this.selectedMessage.unassignedResults && this.selectedMessage.unassignedResults.length &&
            //         this.documentBeingAssigned && this.documentBeingAssigned.docInfo &&
            //         this.targetPats && this.targetPats.length) { // if has unassigned results && docinfo && targetPats
            //         const selMsg = this.selectedMessage
            //         const targets = this.targetPats || []
            //         const document = this.documentBeingAssigned
            //         const docInfo = this.documentBeingAssigned.docInfo || null
            //         this._assignResultToSelected(selMsg,targets,document,docInfo)
            //     } else {
            //         // console.log("assignToPat",this.targetPats)
            //         if (this.targetPats && this.targetPats.length) { // if no unassigned && no docinfo && no targetPats
            //             this.targetPats.map(thisPat=>{
            //                 this.api.contact().newInstance(this.user, thisPat, {
            //                     created: _.get(selectedMessage,"created", new Date().getTime()),
            //                     modified: _.get(selectedMessage,"created", new Date().getTime()),
            //                     author: this.user.id,
            //                     responsible: this.user.healthcarePartyId,
            //                     subContacts: []
            //                 }).then(ctc=>{
            //                     const doc = this.documentsOfMessage.find(d=>d.documentLocation === 'annex' || d.documentLocation === 'body')
            //                     if (doc && doc.id && doc.id.length) {
            //                         const svc = this.api.contact().service().newInstance(this.user, { content: _.fromPairs([[this.language, { documentId: doc.id, stringValue: doc.name || 'annex-'+this.api.moment(Date.now()).format('YYYYMMDD') }]]), label: 'document' });
            //                         ctc.services.push(svc);
            //                         ctc.subContacts = [{ status: 64, services: [{serviceId: svc.id }]}]
            //                         this.api.contact().createContactWithUser(this.user, ctc).then(c=>{
            //                             this.api.register(c,'contact')
            //                             this.closeSuggestions()
            //                         })
            //                     }
            //                 })
            //             })
            //         }
            //     } // else end
            // }




        }

        customElements.define(HtMsgDetail.is, HtMsgDetail);

    </script>



</dom-module>
