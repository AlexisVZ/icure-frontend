<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../../../bower_components/vaadin-material-theme/vaadin-grid.html">
<link rel="import" href="../../../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../../../bower_components/vaadin-grid/vaadin-grid-column.html">
<link rel="import" href="../../../bower_components/vaadin-grid/vaadin-grid-sorter.html">
<link rel="import" href="../../../bower_components/vaadin-themes/material/vaadin-date-picker.html">
<link rel="import" href="../../../bower_components/vaadin-date-picker/vaadin-date-picker.html">
<link rel="import" href="../../../bower_components/vaadin-grid/vaadin-grid-selection-column.html">
<link rel="import" href="../../../bower_components/vaadin-checkbox/vaadin-checkbox.html">

<link rel="import" href="../../../bower_components/paper-progress/paper-progress.html">
<link rel="import" href="../../../bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="../../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">

<link rel="import" href="../dynamic-form/ckmeans-grouping.html">
<link rel="import" href="../ht-spinner/ht-spinner.html">


<dom-module id="ht-msg-documents">
    <template>
        <custom-style>
            <style include="shared-styles">

                :host {
                    display: flex;
                    flex-direction: column;
                    z-index: 0;
                }

                :host *:focus {
                    outline: 0 !important;
                }

                .new-doc-btn{
                    margin: 4px auto 0 auto;
                    box-sizing: border-box;
                    --paper-button-ink-color: var(--app-secondary-color-dark);
                    height: 40px !important;
                    display: block;
                    text-align: center;
                    --paper-button: {
                        background: var(--app-secondary-color);
                        color: var(--app-text-color);
                        width: calc(100% - 48px);
                        margin: 0 auto;
                        font-size: 14px;
                        font-weight: bold;
                        text-transform: capitalize;
                    };
                    white-space: nowrap;
                    text-overflow: ellipsis;
                    overflow: hidden;
                    max-width: 220px;
                    text-transform: uppercase;
                }
                .table-top {
                    width: calc(100vw - 38%);
                    min-height: 56px;
                    display: flex;
                    flex-direction: row;
                    justify-content: flex-end;
                    padding-top:5px;
                }
                .table-top > .checkbox {
                    width: 16px;
                    margin-left: 20px;
                    display: flex;
                    justify-content: space-around;
                    padding-left: 12px;
                    flex-direction: column;
                }
                .table-top > div {
                    display: flex;
                    flex-direction: row;
                    z-index: 1;
                }
                .table-top > div > div {
                    text-align: center;
                }
                .table-top > div.indicators {
                    justify-content: flex-end;
                    padding-right: 24px;
                }
                .table-top > div.indicators > div {
                    display: flex;
                    flex-direction: column;
                    padding: 8px;
                    justify-content: center;
                }
                .table-top > div.indicators > div > * {
                    margin: 0 auto;
                }
                .table-top > div.indicators > div#stamp-indicator.hasNew span {color: var(--app-error-color);}
                .table-top > div.indicators > div#capacity-indicator > * {
                    display: inline-block;
                }
                .table-top > div.actions {
                    flex-grow: 1;
                    margin: 0 16px;
                }
                .table-top paper-dropdown-menu#filterLabresult {
                    min-width: 256px;
                    margin-left: 22%;
                }

                .table-top > div.actions paper-icon-button {
                    margin: 8px 0;
                }

                #loadingContainer, #loadingContainerSmall {
                    position: absolute;
                    width: 100%;
                    height: 100%;
                    top: 0;
                    left: 0;
                    background-color: rgba(0, 0, 0, .3);
                    z-index: 10;
                    text-align: center;
                }

                #loadingContentContainer, #loadingContentContainerSmall {
                    position: relative;
                    width: 400px;
                    min-height: 200px;
                    background-color: #ffffff;
                    padding: 20px;
                    border: 3px solid var(--app-secondary-color);
                    margin: 40px auto 0 auto;
                    text-align: center;
                }

                .modalDialog {
                    height: 300px;
                    width: 600px;
                }

                .modalDialogContent {
                    height: 250px;
                    width: auto;
                    margin: 10px;
                }

                .bold {
                    font-weight: 700;
                }

                .sub-container {
                    position: relative;
                }

                .loadingIcon {
                    margin-right: 5px;
                }

                .loadingIcon.done {
                    color: var(--app-secondary-color);
                }

                .mr5 {
                    margin-right: 5px
                }

                .smallIcon {
                    width: 16px;
                    height: 16px;
                }

                .m-t-40 {
                    margin-top: 40px;
                }

                .m-t-50 {
                    margin-top: 50px !important;
                }

                .m-t-20 {
                    margin-top: 20px !important;
                }

                .m-t-25 {
                    margin-top: 25px !important;
                }

                .textAlignCenter {
                    text-align: center;
                }

                .dialogButtons {
                    position: absolute;
                    bottom: 40px;
                    margin: 0;
                    width: 100%;
                    text-align: center;
                }

                .dialogButtons .modal-button {
                    --paper-button-ink-color: var(--app-secondary-color);
                    background-color: var(--app-secondary-color);
                    color: var(--app-text-color);
                    font-weight: 700;
                    font-size: 14px;
                    height: 40px;
                    min-width: 100px;
                    padding: 10px 1.2em;
                    text-transform: uppercase;
                }

                .dialogButtons .modal-button.grey {
                    --paper-button-ink-color: var(--app-background-color-dark);
                    background-color: var(--app-background-color-dark);
                }

            </style>
        </custom-style>
        <template is="dom-if" if="[[_bodyOverlay]]">
            <div id="loadingContainer"></div>
        </template>
        <template is="dom-if" if="[[_isLoading]]">
            <div id="loadingContainer">
                <div id="loadingContentContainer">
                    <div style="max-width:100px; margin:0 auto">
                        <ht-spinner class="spinner" alt="Loading..." active></ht-spinner>
                    </div>
                    <div id="loadingContent"></div>
                </div>
            </div>
        </template>
        <template is="dom-if" if="[[_isEqual(menuSelectionObject.selection.folder,'todealwith')]]">
            <div class="table-top">
                <div class="checkbox">
                    <vaadin-checkbox id="checkerAll" on-tap="_toggleSelectAllMessages" checked$="{{allSelected}}" value="1"></vaadin-checkbox>
                    <paper-tooltip for="checkerAll">[[localize('sel_all','Select all',language)]]</paper-tooltip>
                </div>
                <div class="actions">

                    <!--<template is="dom-if" if="[[!_haveCheckedMessages]]">-->
                        <!--<template is="dom-if" if="[[refreshAllowed]]">-->
                            <paper-icon-button id="refresh-button" icon="icons:refresh" on-tap="_refresh" disabled="[[!refreshAllowed]]"></paper-icon-button>
                            <paper-tooltip for="refresh-button" offset="2">[[localize('refresh','Refresh',language)]]</paper-tooltip>
                        <!--</template>-->
                    <!--</template>-->

                    <template is="dom-if" if="[[_haveCheckedMessages]]">

                        <template is="dom-if" if="[[!_isEqual(menuSelectionObject.selection.folder,'deleted')]]">
                            <template is="dom-if" if="[[!_isEqual(menuSelectionObject.selection.folder,'hidden')]]">
                                <paper-icon-button id="hide-button" icon="visibility-off" on-tap="_hideUnHideMessages"></paper-icon-button>
                                <paper-tooltip for="hide-button" offset="2">[[localize('hide_sel','Hide selected',language)]]</paper-tooltip>
                            </template>
                        </template>

                        <template is="dom-if" if="[[_isEqual(menuSelectionObject.selection.folder,'hidden')]]">
                            <paper-icon-button id="show-button" icon="undo" on-tap="_hideUnHideMessages"></paper-icon-button>
                            <paper-tooltip for="show-button" offset="2">[[localize('restore','Restore',language)]]</paper-tooltip>
                        </template>

                        <template is="dom-if" if="[[!_isEqual(menuSelectionObject.selection.folder,'deleted')]]">
                            <paper-icon-button id="del-button" icon="delete" on-tap="_deleteMessages"></paper-icon-button>
                            <paper-tooltip for="del-button" offset="2">[[localize('del_sel','Delete selected',language)]]</paper-tooltip>
                        </template>

                        <template is="dom-if" if="[[_isEqual(menuSelectionObject.selection.folder,'deleted')]]">
                            <paper-icon-button id="restore-button" icon="undo" on-tap="_restoreDeletedMessages"></paper-icon-button>
                            <paper-tooltip for="restore-button" offset="2">[[localize('restore','Restore',language)]]</paper-tooltip>
                            <paper-icon-button id="del-for-button" icon="delete-forever" on-tap="_confirmDeleteMessagesForEver"></paper-icon-button>
                            <paper-tooltip for="del-for-button" offset="2">[[localize('del_forever','Delete forever',language)]]</paper-tooltip>
                        </template>

                    </template>

                    <paper-button id="new-doc-btn" class="new-doc-btn" on-tap="_createNewDocument">[[localize('new_out_doc','New Outgoing Document',language)]]</paper-button>

                </div>

                <div class="indicators">

                    <template is="dom-if" if="[[!_isEqual(nbrMessagesInStandBy,0)]]">
                        <div id="stamp-indicator" class="stamp-indicator hasNew errorColor"><iron-icon icon="warning" class="errorColor"></iron-icon><span class="label errorColor fs12">[[nbrMessagesInStandBy]] [[localize('pendingMessages','Pending messages',language)]]</span></div>
                        <paper-tooltip for="stamp-indicator" offset="0">[[localize('becauseEhBoxIsFull','Because your e-Health Box is full',language)]]</paper-tooltip>
                    </template>

                    <div id="capacity-indicator">
                        <div class="mb4"><iron-icon icon="cloud"></iron-icon>
                            <span>
                                <template is="dom-if" if="[[ehealthSession]]">[[localize('mail_cap','mailbox capacity',language)]] ([[currentCapacityPercentage]]%)</template>
                                <template is="dom-if" if="[[!ehealthSession]]"><span class="warn">[[localize('ehe_is_not_con','eHealth is not connected',language)]]</span></template>
                            </span>
                        </div>
                        <template is="dom-if" if="[[ehealthSession]]"><paper-progress value$="[[currentCapacityPercentage]]" min="0" max="100" class$="[[_ehBoxCurrentSizeColor]]"></paper-progress></template>
                    </div>

                    <template is="dom-if" if="[[ehealthSession]]">
                        <paper-tooltip for="capacity-indicator" offset="0">[[currentStorageCapacity]]%</paper-tooltip>
                    </template>

                </div>

            </div>



            <div class="second-panel col-right">
                <ht-spinner class="center" active="[[isLoadingMailList]]"></ht-spinner>
                <vaadin-grid id="vaadinDocumentsGrid" class="material" multi-sort="[[multiSort]]"
                             active-item="{{activeItem}}" items="[[messages]]"
                             on-tap="_documentTapped"
                             selection-mode="multi" width="100%" pageSize="[[_pageSize]]">
                    <vaadin-grid-column flex-grow="0" width="46px">
                        <template>
                            <vaadin-checkbox on-checked-changed="_messageCheckedChanged" data-message-id$="[[item.id]]" class="checkbox"></vaadin-checkbox>
                        </template>
                    </vaadin-grid-column>
                    <vaadin-grid-column flex-grow="1">
                        <template class="header">
                            <vaadin-grid-sorter path="title">[[localize('title','Title',language)]]
                            </vaadin-grid-sorter>
                        </template>
                        <template>
                            <div class$="cell [[_boldIfIsUnread(item)]]">[[item.metas.filename]]</div>
                        </template>
                    </vaadin-grid-column>
                    <vaadin-grid-column flex-grow="0" width="104px">
                        <template class="header">
                            <vaadin-grid-sorter path="import_date" direction="asc">[[localize('import_date','Import Date',language)]]</vaadin-grid-sorter>
                        </template>
                        <template>
                            <div class$="cell [[_boldIfIsUnread(item)]]">[[_msTstampToDDMMYYYY(item.metas.importDate)]]</div>
                        </template>
                    </vaadin-grid-column>
                    <vaadin-grid-column flex-grow="0" width="104px">
                        <template class="header">
                            <vaadin-grid-sorter path="doc_date" direction="asc">[[localize('doc_date','Date',language)]]</vaadin-grid-sorter>
                        </template>
                        <template>
                            <div class$="cell [[_boldIfIsUnread(item)]]">[[_msTstampToDDMMYYYY(item.metas.documentDate)]]</div>
                        </template>
                    </vaadin-grid-column>
                    <vaadin-grid-column flex-grow="1">
                        <template class="header">
                            <vaadin-grid-sorter path="fromAddress"><b>[[localize('hcp','Médecin',language)]]</b></vaadin-grid-sorter>
                        </template>
                        <template>
                            <div class$="cell [[_boldIfIsUnread(item)]]">[[item.hcp]]</div>
                        </template>
                    </vaadin-grid-column>
                    <!--<vaadin-grid-column flex-grow="1">
                        <template class="header">[[localize('pat','Patient',language)]]</template>
                        <template>
                            <div class$="cell [[_boldIfIsUnread(item)]]">[[item.]]</div>
                        </template>
                    </vaadin-grid-column>-->
                    <vaadin-grid-column width="138px" flex-grow="0">
                        <template class="header">
                        </template>
                        <template>
                            <div style="text-align:right;">
                                <template is="dom-if" if="[[_isImportant(item)]]">
                                    <iron-icon id="important-[[item.id]]" icon="warning"></iron-icon>
                                    <paper-tooltip position="left" for="important-[[item.id]]">[[localize('significant','important',language)]]</paper-tooltip>
                                </template>
                                <template is="dom-if" if="[[_isCrypted(item)]]">
                                    <iron-icon id="crypted-[[item.id]]" icon="lock"></iron-icon>
                                    <paper-tooltip position="left" for="crypted-[[item.id]]">[[localize('encrypted','encrypted',language)]]</paper-tooltip>
                                </template>
                                <template is="dom-if" if="[[_hasAnnex(item)]]">
                                    <iron-icon id="hasAnnex-[[item.id]]" icon="editor:attach-file"></iron-icon>
                                    <paper-tooltip position="left" for="hasAnnex-[[item.id]]">[[localize('has_attach','Has attachments',language)]]</paper-tooltip>
                                </template>
                            </div>
                        </template>
                    </vaadin-grid-column>
                </vaadin-grid>
                <div class="bottom-commands">
                    <template is="dom-if" if="[[!isLoadingMailList]]">
                        <div class="grid-size-indicator nophone"> [[pageStart]] – [[pageEnd]] [[localize('sur','sur',language)]] [[gridSize]]</div>
                        <paper-icon-button id="previous-page-change" icon="chevron-left"class="change-page" on-tap="_prevPage"></paper-icon-button>
                        <paper-icon-button id="next-page-change" icon="chevron-right" class="change-page" on-tap="_nextPage"></paper-icon-button>

                        <div class="nophone"><paper-icon-button id="scrolltop" class="scroll-top" icon="arrow-upward" on-tap="_scrollToTop"></paper-icon-button></div>
                        <paper-tooltip for="previous-page-change" position="left" offset="12">[[localize('page_prev','Previous page',language)]]</paper-tooltip>
                        <paper-tooltip for="next-page-change" position="right" offset="-5">[[localize('page_next','Next page',language)]]</paper-tooltip>
                        <paper-tooltip for="scrolltop" position="left">[[localize('scrolltop_list','Scroll to top of the list',language)]]</paper-tooltip>
                    </template>
                </div>
            </div>



        </template>
        <template is="dom-if" if="[[_isEqual(menuSelectionObject.selection.folder,'dealtwith')]]">
            <h4>Documents traités</h4>
            <p>En cours de développement...</p>
        </template>
        <paper-dialog class="modalDialog" id="confirmPermanentDeletionDialog" no-cancel-on-outside-click
                      no-cancel-on-esc-key>
            <h2 class="modal-title">
                <iron-icon icon="icons:warning"></iron-icon>
                [[localize('warning','Warning',language)]]
            </h2>
            <div class="modalDialogContent m-t-50">
                <h3 class="textAlignCenter">[[localize('confirmDeletePermanently','Are you sure you wish to delete
                    PERMANENTLY ?',language)]]</h3>
                <p class="textAlignCenter m-t-20">[[localize('cantBeUndone',"This can't be undone",language)]].</p>
            </div>
            <div class="dialogButtons">
                <paper-button class="modal-button grey" on-tap="_closeDialogs">
                    <iron-icon icon="icons:close" class="mr5 smallIcon"></iron-icon>
                    [[localize('can','Cancel',language)]]
                </paper-button>
                <paper-button class="modal-button" on-tap="_deleteMessagesForEver">
                    <iron-icon icon="check-circle" class="mr5 smallIcon"></iron-icon>
                    [[localize('confirm','Confirm',language)]]
                </paper-button>
            </div>
        </paper-dialog>
    </template>
    <script>
        import moment from 'moment/src/moment';
        import _ from 'lodash/lodash';
        import * as models from 'icc-api/dist/icc-api/model/models'
        class HtMsgDocuments extends Polymer.TkLocalizerMixin(Polymer.Element) {
            static get is() {
                return 'ht-msg-documents';
            }

            static get properties() {
                return {
                    api: {
                        type: Object,
                        noReset: true
                    },
                    user: {
                        type: Object,
                        noReset: true
                    },
                    menuSelectionObject: {
                        type: Object
                    },
                    i18n: {
                        Type: Object,
                        value: function () {
                            moment.locale('fr');
                            const res = {
                                monthNames: moment.months(),
                                weekdays: moment.weekdays(),
                                weekdaysShort: moment.weekdaysShort(),
                                firstDayOfWeek: moment.localeData().firstDayOfWeek(),
                                week: 'Semaine',
                                calendar: 'Calendrier',
                                clear: 'Clear',
                                today: 'Aujourd\'hui',
                                cancel: 'Annuler',
                                formatDate: function (d) {
                                    //return moment(d).format(moment.localeData().longDateFormat('L'))
                                    return moment(d).format('DD/MM/YYYY');
                                },
                                parseDate: function (s) {
                                    return moment(s, 'DD/MM/YYYY').toDate();
                                },
                                formatTitle: function (monthName, fullYear) {
                                    return monthName + ' ' + fullYear;
                                }
                            };
                            return res;
                        },
                        noReset: true
                    },
                    _bodyOverlay: {
                        type: Boolean,
                        value: false
                    },
                    _loadingMessages: {
                        type: Array,
                        value: () => []
                    },
                    _isLoading: {
                        type: Boolean,
                        value: false,
                        observer: '_loadingStatusChanged'
                    },
                    _importedDocumentType: {
                        type: Array,
                        value: ['SCAN', 'IMPORT', 'HUB']
                    },
                    page: {
                        type: Number,
                        value: 1
                    },
                    pages: {
                        type: Array,
                        value: []
                    },
                    pageStart: {
                        type: Number,
                        value: 0
                    },
                    pageEnd: {
                        type: Number,
                        value: 50
                    },
                    activeItem: {
                        type: Object,
                        value: null
                    },
                    messages: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },

                };
            }

            constructor() {
                super();
            }

            static get observers() {
                return [];
            }

            ready() {
                super.ready();
            }

            _loadingStatusChanged() {
                if (!this._isLoading) this._resetLoadingMessage();
            }

            _resetLoadingMessage() {
                this._loadingMessages = [];
            }

            _setLoadingMessage(messageData) {
                setTimeout(() => {
                    if (messageData.updateLastMessage) this._loadingMessages.pop();
                    this._loadingMessages.push(messageData);
                    let loadingContentTarget = this.shadowRoot.querySelectorAll('#loadingContent')[0];
                    if (loadingContentTarget) {
                        loadingContentTarget.innerHTML = '';
                        _.each(this._loadingMessages, (v) => {
                            loadingContentTarget.innerHTML += "<p><iron-icon icon='" + v.icon + "' class='" + (v.done ? "loadingIcon done" : "loadingIcon") + "'></iron-icon>" + v.message + "</p>";
                        });
                    }
                }, 100)
            }

            _msTstampToDDMMYYYY(msTstamp) {
                return parseInt(msTstamp) ? this.api.moment(parseInt(msTstamp)).format('DD/MM/YYYY') : ""
            }

            _closeDialogs() {
                this.set("_bodyOverlay", false);
                _.map(this.shadowRoot.querySelectorAll('.modalDialog'), i => i && typeof i.close === "function" && i.close())
            }

            _isEqual(a, b) {
                return !!(a === b)
            }

            _getMessages(currentFolder) {
                if(!currentFolder) return Promise.resolve(null);

                this.set('page',1);
                let foundMessages = [];

                return !currentFolder ?
                    foundMessages :

                    Promise.all(this._importedDocumentType.map(importedDocumentType => this.api.message().findMessagesByTransportGuid('DOC:' + importedDocumentType + ':IN', null, null, null, 1000)
                        .then(messages => {
                            console.log('message count: ', messages.rows.length);
                            return messages.rows.filter(m => currentFolder === 'todealwith' ? this._dealtWith(m) : !this._dealtWith(m))
                        })
                        .then(messages => _.orderBy(messages, ['created','transportGuid'],['desc','desc']))
                    ))
                    //.then(messages => Promise.all(this._decryptAll(messages)))))
                    .then(messagesByType => _.flatten(messagesByType))
                    .then(messages => foundMessages=_.compact(messages||[]))
                    .catch(e=>{
                        console.log(e);
                        return []
                    })
                    .finally(()=>foundMessages)
            }


            /*_decryptAll(messages) {
                messages.map(docMessage => this.api.document().findByMessage(this.user.healthcarePartyId, docMessage)
                    .then(found => {
                        this.firstFound = found[0];
                        return this.api.document().getAttachment(found[0].id, found[0].attachmentId, found[0].secretForeignKeys);
                    })
                    .then(attachmentResponse => this.api.encryptDecryptFileContentByUserHcpIdAndDocumentObject("decrypt", this.user, this.firstFound, attachmentResponse))
                    // .then(decryptedFileContent => this.api.triggerFileDownload(decryptedFileContent,"application/pdf", _.get(docMessage, "filename","my-scanned-document.pdf")))
                    .catch(error=> console.log('error:', error)))
            }*/

            _dealtWith(m) {
                return !!((m.status & (1 << 26)) !== 0)
            }




            _refresh() {
                if (this.menuSelectionObject && this.menuSelectionObject.selection) {

                    this._resetLoadingMessage();
                    this.set('_isLoading', true );
                    this._setLoadingMessage({ message:this.localize('ehb.gettingMessages',this.language), icon:"arrow-forward"});

                    const currentFolder = _.trim(_.get(this,"menuSelectionObject.selection.folder","todealwith"))

                    this._getMessages(currentFolder)
                        .then(foundMessages=>{
                            this._setLoadingMessage({ message:this.localize('ehb.gettingMessages_done',this.language), icon:"check-circle", updateLastMessage: true, done:true});
                            this.set("messages", foundMessages)
                            this.set('_isLoading', false );
                        })
                        .catch(e=>{ console.log(e); })
                        .finally(()=>{
                            this.dispatchEvent(new CustomEvent('selection-messages-change', { detail: { selection: { item: null } } }));
                            this.triggerGridResize()
                        })

                } else {
                    this.dispatchEvent(new CustomEvent('selection-messages-change', { detail: { selection: { item: null } } }));
                    this.triggerGridResize()
                }
            }

            triggerGridResize() {
                const grid = this.shadowRoot.getElementById('vaadinDocumentsGrid')
                return grid && grid.notifyResize()
            }


            _messageCheckedChanged(e) {

                const isChecked = !!_.get(e,"detail.value",false)
                const messageId = _.trim(_.get(e,"path[0].dataset.messageId",""))
                const messageObject = _.find( _.get(this,"messages",[]),i=>_.trim(_.get(i,"id",""))===messageId )

                // Could be during initialization
                if(!_.trim(_.get(e,"path[0].dataset.messageId"))) return;

                if(!!isChecked) this.set("checkedMessages", _.uniqBy(_.concat(_.get(this,"checkedMessages",[]),messageObject), 'id'))
                if(!isChecked) _.remove(this.checkedMessages,i=>_.trim(_.get(i,"id",""))===messageId)

                const totalCheckMessages = _.size(_.get(this,"checkedMessages",[]));
                this.set("_haveCheckedMessages", !!totalCheckMessages);
                return this.set('allSelected',( totalCheckMessages ===_.size(_.get(this,"messages",[])) || totalCheckMessages === parseInt(_.get(this,"_pageSize",50)) ))

            }

        }

        customElements.define(HtMsgDocuments.is, HtMsgDocuments);
    </script>
</dom-module>
