<link rel="import" href="../dynamic-form/dynamic-subcontact-type-selector.html">

<dom-module id="ht-msg-import-doc-dialog">
    <template>
        <style>
            .buttons{
                display: flex;
                flex-grow: 1;
                box-sizing: border-box;
                justify-content: flex-end;
                padding: 16px 12px 8px 16px;
            }

            paper-dialog {
                width: 50%;
                min-width:30%;
                margin: 0;
            }

            .input-form{
                width : calc(100% - 40px);
                height: 40px;
            }

            vaadin-upload{
                margin:16px;
                margin-bottom: 0;
                min-height:280px;
                background: var(--app-background-color);
                --vaadin-upload-buttons-primary: {
                    padding:16px;
                };
                --vaadin-upload-button-add: {
                    background: var(--app-secondary-color);
                    color:var(--app-text-color);
                };
                --vaadin-upload-file-progress: {
                    --paper-progress-active-color:var(--app-secondary-color);
                };
                --vaadin-upload-file-commands: {
                    color: var(--app-primary-color);
                }

            }

            vaadin-text-field{
                height: 40px;
                margin-top: -20px;
            }
            #importTextField,#hcpCombo,#typeCombo{
                width: 100%;
            }
            #importPicker,#docPicker,#PatCombo,#NissTextField{
                width: calc(50% - 2px);
            }
        </style>
        <paper-dialog id="upload-dialog">
            <h2>[[localize('upl_fil','Upload files',language)]]<span class="extra-info">(PDF, images and videos)</span></h2>
            <!--<paper-fab class="close-button-icon" icon="icons:close" dialog-dismiss></paper-fab>-->
            <div class="input-form">
                <vaadin-text-field id="importTextField" label="[[localize('doc-title','Titre du document',language)]]" value="{{importDocName}}"></vaadin-text-field>
            </div>
            <div class="input-form">
                <vaadin-date-picker id="importPicker" label="[[localize('doc_dat','Date d\'importation',language)]]" value="{{importDate}}" i18n="[[i18n]]"></vaadin-date-picker>
                <vaadin-date-picker id="docPicker" label="[[localize('doc_dat','Date du document',language)]]" value="{{docDate}}" i18n="[[i18n]]"></vaadin-date-picker>
            </div>
            <div class="input-form">
                <vaadin-combo-box id="hcpCombo" filtered-items="[[listHcp]]" on-filter-changed="_filterHcpChanged" item-label-path="name" item-value-path="id" label="[[localize('hcp','Medecin',language)]]" value="{{selectedHcp}}">
                </vaadin-combo-box>
            </div>
            <div class="input-form">
                <vaadin-combo-box id="typeCombo" filtered-items="[[listType]]" item-label-path="name" item-value-path="id" label="[[localize('type-doc','Type de document',language)]]" value="{{selectedtypeDoc}}">
                </vaadin-combo-box>
            </div>
            <div class="input-form">
                <vaadin-combo-box id="PatCombo" filter="{{filterPatient}}" label="[[localize('pat-name','Nom du patient',language)]]" filtered-items="[[listPat]]" item-label-path="name" item-value-path="id" value="{{patientId}}" disabled="[[patientDisabled]]"></vaadin-combo-box>
                <vaadin-text-field id="NissTextField" label="[[localize('ssin','NISS',language)]]" value="{{patientNiss}}" disabled="[[patientDisabled]]"></vaadin-text-field>
            </div>
            <template is="dom-if" if="[[_hasScanners(hasElectron,scannerList)]]">
                <div class="buttons">
                    <vaadin-combo-box id="scannerList" filtered-items="[[scannerList]]" item-label-path="label" item-value-path="id" label="[[localize('scanners','Scanners',language)]]" value="{{selectedScanner}}"></vaadin-combo-box>
                    <paper-button class="modal-button" on-tap="_launchScan">[[localize('scan','Scan',language)]]</paper-button>
                </div>
            </template>
            <vaadin-upload id="vaadin-upload" no-auto files="{{files}}" accept="video/*,image/*,application/pdf,text/xml,application/xml,text/plain" target="[[api.host]]/document/{documentId}/attachment/multipart;jsessionid=[[api.sessionId]]" method="PUT" form-data-name="attachment" on-upload-success="_fileUploaded"></vaadin-upload>
            <div class="buttons">
                <paper-button class="modal-button modal-button--cancel" dialog-dismiss>[[localize('clo','Close',language)]]</paper-button>
            </div>
        </paper-dialog>
    </template>
    <script>

        import _ from 'lodash/lodash';
        import moment from 'moment/src/moment';

        class HtMsgImportDocDialog extends Polymer.TkLocalizerMixin(Polymer.Element) {
            static get is() {
                return 'ht-msg-import-doc-dialog';
            }

            static get properties() {
                return {
                    api: {
                        type: Object,
                        observer: "apiReady"
                    },
                    doc: {
                        type: Boolean,
                        value: true
                    },
                    user: {
                        type: Object,
                        observer : "_userChanged"
                    },
                    patient: {
                        type: Object,
                        observer : "_patientChanged"
                    },
                    files: {
                        type: Array
                    },
                    isLoadingDoc: {
                        type: Boolean,
                        value: false
                    },
                    documentMetas: {
                        type: Object,
                        value: null
                    },
                    savedDocTemplateId: {
                        type: String,
                        value: ""
                    },
                    selectedScanner:{
                        type : String,
                        value : ""
                    },
                    scannerList:{
                        type: Array,
                        value : ()=> []
                    },
                    hasElectron:{
                        type: Boolean,
                        value : false,
                        observer: '_hasElectronChanged'
                    },
                    importDocName:{
                        type : String,
                        value : ""
                    },
                    importDate: {
                        type : String,
                        value: moment().format("YYYY-MM-DD")
                    },
                    docDate :{
                        type : String,
                        value: moment().format("YYYY-MM-DD")
                    },
                    selectedHcp :{
                        type: String,
                        value : ""
                    },
                    listHcp :{
                        type : Array,
                        value: ()=>[]
                    },
                    patientId:{
                        type: String,
                        value : "",
                        observer : "_patientIdChanged"
                    },
                    patientNiss:{
                        type: String,
                        value : "",
                        observer:"_patientNissChanged"
                    },
                    listPat:{
                        type : Array,
                        value: ()=>[]
                    },
                    filterPatient:{
                        type:String,
                        value:""
                    },
                    selectedtypeDoc:{
                        type: String,
                        value:""
                    },
                    listType:{
                        type: Array,
                        value: ()=>[]
                    },
                    patientDisabled:{
                        type: Boolean,
                        value:false
                    }
                };
            }

            static get observers() {
                return ['_filesChanged(files.*)',"_filterPatChanged(filterPatient)"];
            }

            constructor() {
                super();
            }

            ready() {
                super.ready();
            }

            apiReady(){
                this.api.isElectronAvailable().then(electron => this.set("hasElectron",electron))
                this.api.code().findPaginatedCodes('be', 'CD-TRANSACTION', '')
                    .then(codes => this.set("listType",codes.rows.filter(code=>["careplan","contactreport","diarynote","labrequest","labresult","mea","note","prescription","referral","report","request","result"].find(keyWord=>code.code.includes(keyWord))).map(code => {return{id:code.id,name:code.label[this.language]||code.label["en"]||""}})))
            }

            _hasElectronChanged(){
                if(!this.hasElectron)return;
                Promise.all([fetch("http://localhost:16042/scanning",{
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({
                        request : "list"
                    })
                }), fetch('http://localhost:16042/getPrinterSetting', {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json; charset=utf-8"
                    },
                    body: JSON.stringify({
                        userId: this.user.id
                    })
                })
                ]).then(response => Promise.all(response.map(rep=>rep.json()))).then(([data, settings])=>{
                    if(!data.ok)return;
                    const scanner = settings && settings.data && settings.data !== 'error' && JSON.parse(settings.data).find(set => set.type==="scanner")
                    this.set("selectedScanner", scanner && data.data.all.find(scan => scan.id===scanner.printer || scan.label===scanner.printer) ? scanner.printer :data.data.default.id)
                    this.set("scannerList",data.data.all)
                })
            }

            _userChanged(){
                if(!this.user)return;
                this.api.hcparty().getHealthcareParty(this.user.healthcarePartyId).then(tempHcp => {
                    this.push("listHcp",{
                        id:tempHcp.id,
                        name:tempHcp.name || tempHcp.firstName+" "+tempHcp.lastName || tempHcp.id})
                    this.set("selectedHcp",this.user.healthcarePartyId)
                })
            }

            _patientChanged(){
                if(!this.patient)return;
                this.push("listPat",{
                    id:this.patient.id,
                    name:this.patient.firstName+" "+this.patient.lastName || this.patient.id,
                    ssin : this.patient.ssin})
                this.set("patientId",this.patient.id)
                this.set("patientDisabled",true)
            }

            _patientIdChanged(){
                (this.listPat.find(pat =>  pat.id===this.patientId)||{ssin:""}).ssin!==this.patientNiss && this.set("patientNiss",(this.listPat.find(pat => pat.id===this.patientId)||{ssin:""}).ssin)
            }

            _patientNissChanged(){
                if(!this.patientNiss || !this._validSsin(this.patientNiss)) return;
                const found =this.listPat.find(pat => pat.ssin===this.patientNiss)
                if(found){
                    this.patientId!==found.id && this.set("patientId",found.id)
                }
                else{
                    this.api.patient().filterByWithUser(this.user,null,null,10,null,null,"desc",{
                        filter: {
                            '$type': 'PatientByHcPartyAndSsinFilter',
                            'healthcarePartyId': this.selectedHcp,
                            'ssin': this.patientNiss
                        }
                    }).then(pats => {

                        pats.rows.map(pat => this.push("listPat",{
                            id: pat.id,
                            name: pat.firstName + " " + pat.lastName || pat.id,
                            ssin: pat.ssin
                        }))
                        this.set("patientId",this.listPat.find(pat => pat.ssin===this.patientNiss).id)
                    })
                }
            }

            _filterHcpChanged(e){
                if(!e.detail.value)return;
                this.api.hcparty().findByName(e.detail.value,null,null,100,"desc").then(hcps =>{
                    this.set("listHcp",hcps.rows.map(hcp =>{
                        return {
                            id : hcp.id,
                            name : hcp.name ||  hcp.firstName+" "+hcp.lastName || hcp.id
                        }
                    }))
                })
            }

            _filterPatChanged(e){
                if(!this.filterPatient || !this.selectedHcp)return;
                this.api.patient().filterByWithUser(this.user, null, null, 50, null, null, true, {
                    filter: {
                        '$type': 'PatientByHcPartyNameContainsFuzzyFilter',
                        'healthcarePartyId': this.selectedHcp,
                        'searchString': this.filterPatient
                    }
                }).then(pats =>{
                    this.set("listPat",pats.rows.map(pat =>{
                        return {
                            id : pat.id,
                            name : pat.firstName+" "+pat.lastName || pat.id,
                            ssin : pat.ssin
                        }
                    }))
                })
            }

            _onDrag(e) {
                if (this._hasCurrentContact(this.contacts) && e && e.dataTransfer && e.dataTransfer.items && _.find(e.dataTransfer.items, i => i.kind === 'file')) {
                    this.addDocument();
                }
            }


            /*_filesChanged() {
                if (!this.currentContact) {
                    return;
                }
                const files = _.clone(this.files);
                const vaadinUpload = this.$['vaadin-upload'];

                Promise.all(files.filter(f => !f.attached).map(f => {
                    f.attached = true;
                    console.log(f)
                    return this.api.document().newInstance(this.user, null, { documentType: 'result', mainUti: this.api.document().uti(f.type, f.name && f.name.replace(/.+\.(.+)/, '$1')), name: f.name })
                        .then(d => this.api.document().createDocument(d))

                        .then(createdDocument => {
                            return this.api.crypto()
                                .extractKeysFromDelegationsForHcpHierarchy(
                                    this.user.healthcarePartyId,
                                    createdDocument.id,
                                    _.size(createdDocument.encryptionKeys) ? createdDocument.encryptionKeys : createdDocument.delegations
                                )
                                .then(({extractedKeys: enckeys}) => [createdDocument,enckeys])
                        })
                        .then(([d,enckeys]) => {
                            f.doc = d;
                            f.uploadTarget = (f.uploadTarget || vaadinUpload.target).replace(/\{documentId\}/, d.id) + "?ts=" + new Date().getTime() + (enckeys ? "&enckeys=" + enckeys : "");
                            return f;
                        });
                })).then(files => {
                    files.length && vaadinUpload.uploadFiles(files);
                });
            }

            _fileUploaded(e) {
                if (!this.currentContact) {
                    return;
                }
                const vaadinUpload = this.$['vaadin-upload'];
                const f = e.detail.file;
                const d = f.doc;

                let sc = this.currentContact.subContacts.find(sbc => (sbc.status || 0) & 64);
                if (!sc) {
                    sc = { status: 64, services: [] };
                    this.currentContact.subContacts.push(sc);
                }
                const svc = this.api.contact().service().newInstance(this.user, { content: _.fromPairs([[this.language, { documentId: d.id, stringValue: f.name }]]), label: 'document' });
                this.currentContact.services.push(svc);
                sc.services.push({ serviceId: svc.id });
                if (!vaadinUpload.files.find(f => !f.complete && !f.error)) {
                    this.saveCurrentContact().then(c => this._contactsChanged());
                }
                console.log(vaadinUpload.files)
            }*/

            _validSsin(ssin) {
                return ssin && ssin.length > 9;
            }

            _hasScanners(){
                return this.hasElectron && this.scannerList && this.scannerList.length;
            }

            _launchScan(){
                fetch("http://localhost:16042/scanning",{
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({
                        request : "scan",
                        scanner : this.selectedScanner
                    })
                }).then(response => response.json()).then(response => {
                    if (!response.ok) return;

                    let myObject = {
                        downloadFileName: _.kebabCase(_.compact([
                            this.scanDate || moment().format("DD-MM-YYYY"),
                            this.scannedDocName || "new_scanned_document",
                        ]).join(" ")) + ".pdf",
                        scannedFileBlob: this.api.crypto().utils.base64toArrayBuffer(response.data.base64)
                    }

                    this.api.document().newInstance(this.user, null, {
                        documentType: 'result',
                        mainUti: this.api.document().uti("application/pdf"),
                        name: _.trim(myObject.downloadFileName)
                    }).then(newDocumentInstance => this.api.document().createDocument(newDocumentInstance))
                        .then(createdDocument => {
                            _.merge(myObject, {createdDocument:createdDocument})
                            return createdDocument
                        })
                        .then((createdDocument) => {
                            return this.api.document().setAttachment(createdDocument.id, null, myObject.scannedFileBlob).then(setAttachmentResponse => _.assign({setAttachmentResponse: setAttachmentResponse}, myObject))
                        })
                        .then(resourcesObject => this._saveDocumentAsService({
                            documentId: _.trim(_.get(resourcesObject, "createdDocument.id", "")),
                            stringValue: _.trim(resourcesObject.downloadFileName),
                            formId: "",
                            contactId: _.trim(this.currentContact.id)
                        }))
                        .catch((e) => {
                            console.log("---error upload attachment---");
                        })
                })
            }

            open() {
                const vaadinUpload = this.$['vaadin-upload'];
                vaadinUpload.set('i18n.addFiles.many', this.localize('upl_fil','Upload file',this.language))
                vaadinUpload.set('i18n.dropFiles.many', this.localize('uplabel','Drop files here...',this.language))
                this.set('files', []);
                this.$['upload-dialog'].open();
            }

        }

        customElements.define(HtMsgImportDocDialog.is, HtMsgImportDocDialog);
    </script>
</dom-module>
