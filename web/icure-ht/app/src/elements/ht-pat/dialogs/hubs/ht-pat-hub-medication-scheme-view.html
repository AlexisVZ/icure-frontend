<link rel="import" href="../../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../../bower_components/vaadin-icons/vaadin-icons.html">
<link rel="import" href="../../../../../bower_components/vaadin-material-theme/vaadin-date-picker.html">
<link rel="import" href="../../../../../bower_components/vaadin-material-theme/vaadin-text-field.html">
<link rel="import" href="../../../../../bower_components/vaadin-material-theme/vaadin-checkbox.html">
<link rel="import" href="../../../../../bower_components/vaadin-date-picker/vaadin-date-picker.html">
<link rel="import" href="../../../../../bower_components/vaadin-form-layout/vaadin-form-layout.html">
<link rel="import" href="../../../../../bower_components/vaadin-combo-box/vaadin-combo-box.html">
<link rel="import" href="../../../../../bower_components/vaadin-text-field/vaadin-text-area.html">
<link rel="import" href="../../../../../bower_components/vaadin-checkbox/vaadin-checkbox.html">
<link rel="import" href="../../../../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../../../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="../../../../../bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="../../../dynamic-form/dynamic-link.html">
<link rel="import" href="../../../dynamic-form/dynamic-pills.html">
<link rel="import" href="../../../ht-spinner/ht-spinner.html">

<dom-module id="ht-pat-hub-medication-scheme-view">
    <template>
        <style include="dialog-style atc-styles scrollbar-style">
            paper-dialog {
                width: 90%;
                height: 80%;
            }

            paper-tabs {
                width: 50%;
                max-width: 400px;
                --paper-tabs-selection-bar-color: var(--app-secondary-color);
                /* margin: 0 auto; */
            }

            paper-tab {
                --paper-tab-ink: var(--app-secondary-color);
            }

            .present, .patient {
                height: 100%;
                overflow-y: auto;
                margin-top: 0;
                box-sizing: border-box;
            }

            .table-container {
                margin-bottom: 24px;
            }

            .header {
                background: linear-gradient(to right, var(--app-secondary-color), var(--app-secondary-color-dark));
                color: var(--app-text-color);
                display: flex;
                flex-flow: row wrap;
                justify-content: flex-start;
                align-items: center;
                height: 40px;
                width: 100%;
                padding: 0 12px;
                box-sizing: border-box;
            }

            .header h3 {
                font-size: 14;
                font-weight: 400;
                margin: 0;
            }

            .header iron-icon {
                height: 20px;
                width: 20px;
                margin-right: 4px;
            }

            .table-header {
                width: 100%;
                display: flex;
                flex-flow: row nowrap;
                justify-content: space-between;
                align-items: center;
                border-bottom: 1px solid var(--app-background-color-dark);
                font-size: 11px;
                color: var(--app-text-color-disabled);
                height: 28px;
            }

            .col {
                height: 100%;
                padding: 0 4px;
                box-sizing: border-box;
                display: flex;
                flex-flow: row wrap;
                justify-content: center;
                align-items: center;
            }

            .col--med {
                width: 30%;
                justify-content: flex-start;
            }

            .med--name {
                font-weight: 500;
                margin-right: 4px;
            }

            .col--photo {
                max-width: 56px;
                min-width: 56px;
                text-align: center;
                flex-grow: 1;
            }

            .col--bef, .col--dur, .col--aft {
                max-width: 56px;
                min-width: 56px;
                text-align: center;
                flex-grow: 1;
            }

            .col--noMoment{
                max-width: 168px;
                min-width: 168px;
                text-align: center;
                flex-grow: 1;
            }

            .dur-pill {
                background: var(--app-secondary-color);
                color: var(--app-text-color);
                font-weight: 500;
                border-radius: 50%;
                padding: 4px;
                display: block;
                height: 12px;
                width: 12px;
                line-height: 1.1;
                text-align: center;
            }

            .col--ed, .col--freq {
                text-align: center;
                width: 12%;
            }

            .col--com {
                width: 40%;
                justify-content: flex-start;
            }

            .table-row {
                width: 100%;
                display: flex;
                flex-flow: row nowrap;
                justify-content: space-between;
                align-items: center;
                font-size: 12px;
                color: var(--app-text-color);
                height: 40px;
            }

            .table-row:nth-child(even) {
                background: var(--app-background-color-light);
            }

            .table-row .col:not(:last-child) {
                border-right: 1px solid var(--app-background-color-dark);
            }

            .general-infos {
                display: flex;
                flex-flow: row wrap;
                justify-content: flex-start;
                align-items: center;
                margin-bottom: 24px;
                background: var(--app-background-color-dark);
                padding: 12px;
                border-radius: 4px;
            }

            .infos-block {
                font-size: 14px;
                font-weight: 400;
                color: var(--app-text-color);
                margin-right: 24px;
            }

            .infos-block > div:first-child{
                margin-bottom: 8px;
            }

            .infos-block span {
                background: var(--app-background-color-light);
                border-radius: 12px;
                font-weight: 500;
                padding: 1px 8px;
                margin-right: 8px;
            }

            /* PRESENT */

            .table {
                display: flex;
                flex-flow: column nowrap;
                font-size: .8rem;
                margin: 0.5rem;
                line-height: 1.5;
                flex: 1 1 auto;
            }

            .table div{
                box-sizing: border-box;
            }

            .th {
                display: none;
                font-weight: 700;
                background-color: var(--app-background-color- );
            }

            .th:first-child {
                border-top: 1px solid var(--app-background-color-dark);
            }


            .th > .td {
                white-space: nowrap;
                text-overflow: ellipsis;
                justify-content: center;
            }

            .th .td {
                color: var(--app-text-color);
            }

            .th .td:first-child, .tr.category .td:first-child{
                width: 24px;
                max-width: 24px;
                box-sizing: border-box;
                border-right: none;
            }

            .tr {
                position: relative;
                width: 100%;
                display: flex;
                flex-flow: row nowrap;
                color: var(--app-text-color);
                z-index: 1;
                height: 24px;
            }

            .tr:not(.th):not(.category)::after {
                display: block;
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                height: 100%;
                width: 100%;
                z-index: 0;
            }

            .tr:not(.td):nth-child(odd)::after {
                opacity: 0.6;
                transition: all .24s cubic-bezier(0.075, 0.82, 0.165, 1);
            }

            .tr:not(.td):nth-child(even)::after {
                opacity: 0.8;
                transition: all .24s cubic-bezier(0.075, 0.82, 0.165, 1);
            }

            .tr:not(.td):hover::after {
                opacity: 1;
            }

            .tr.old {
                color: var(--app-text-color-disabled)!important;
            }
            .tr.old::after {
                background: var(--app-background-color-light)!important;
            }

            .tr:not(.category) {
                color: black;
            }

            .tr:nth-of-type(even) {
                background-color: var(--app-background-color-light);
            }

            .td {
                position: relative;
                display: flex;
                flex-flow: row nowrap;
                align-items: center;
                justify-content: center;
                flex-grow: 1;
                flex-basis: 0;
                padding: 0.5em;
                overflow: hidden;
                min-width: 0px;
                z-index: 2;
                word-break: break-word;
                white-space: nowrap;
                border-right: 1px solid var(--app-background-color-dark);
                font-size: 13px;
            }

            .td span{
                text-overflow: ellipsis;
                width: 100%;
                overflow: hidden;
                text-align: center;
            }

            .td span.left{
                text-align: left;
            }

            .td-input{
                position: relative
            }

            .td iron-input > input{
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                text-align: center;
                width: 100%;
                color: #fff;
                background-color: transparent;
                border: none;
                height: 100%;
                outline: 0;
                transition: all .24s cubic-bezier(0.075, 0.82, 0.165, 1);
            }

            .td iron-input > input:focus{
                animation: .24s ease-in forwards inputShadows;
            }

            .td iron-input > input:hover{
                background-color: rgba(0, 0, 0, .2);
                box-shadow: var(--app-shadow-elevation-1);
            }

            @keyframes inputShadows{
                from{ box-shadow: inset 0 0 0 rgba(0, 0, 0, .2); }
                to{ box-shadow: inset 0 0 50px rgba(0, 0, 0, .2); }
            }

            .td:first-child {
                border-left: 1px solid var(--app-background-color-dark);
            }

            .td--comments, .td--medicine, .td--category {
                justify-content: flex-start;
            }

            .td--category iron-icon {
                height: 14px;
                width: 14px;
                margin-right: 4px;
            }

            .th .td {
                border-bottom: 1px solid var(--app-background-color-dark);
            }

            .span-3 {
                padding: 6px 19px; /* 19px because we had the padding of the missings .td padding + their borders */
            }

            .table .category {
                border-bottom: 1px solid #d0d0d0;
            }

            .reimbursed{
                width: 24px;
                max-width: 24px;
                box-sizing: border-box;
                padding: 0;
                border-right: none!important;
            }

            .reimbursed .reimbursed-status {
                height: 14px;
                width: 14px;
                padding: 2px;
                border-radius: 50%;
                box-shadow: 0 0 0 rgba(0, 0, 0, .2);
                transition: all .24s cubic-bezier(0.075, 0.82, 0.165, 1);
                z-index: 3;
            }

            .add-period-btn {
                height: 16px;
                width: 16px;
                padding: 0;
                color: var(--app-text-color);
                transition: all .24s cubic-bezier(0.075, 0.82, 0.165, 1);
            }

            .add-period-btn:hover {
                height: 18px;
                width: 18px;
                color: var(--app-secondary-color);
            }


            /* HISTORY */

            .history{
                margin-top: 24px;
            }

            .timeline-header{
                display: flex;
                flex-flow: row nowrap;
                justify-content: space-between;
                background: var(--app-background-color-light);
                border: 1px solid var(--app-background-color-dark);
            }

            .timeline div {
                box-sizing: border-box;
            }

            .years-container{
                max-width: calc(24px * 36 + 2px);
                width: calc(24px * 36 + 2px); /* 3 years + borders */
                overflow-x: auto;
                overflow-y: hidden;
                flex-grow: 1;
                display: flex;
                flex-flow: row nowrap;
                justify-content: flex-start;
                align-items: center;
                border-left: 1px solid var(--app-background-color-dark);
                border-right: 1px solid var(--app-background-color-dark);
                position: relative;
            }

            .year-block{
                height: 48px;
                min-width: calc(24px * 12 + 3px); /* 3 borders */
                text-align: center;
                display:flex;
                flex-flow: row wrap;
                justify-content: space-between;
                align-items: center;
            }

            .year-block:not(:last-child){
                border-right: 1px solid var(--app-background-color-dark);
            }

            .year-block.current{
                font-weight: 500;
            }

            .year{
                width: 100%;
                height: 50%;
                border-bottom: 1px solid var(--app-background-color-dark);
            }

            .quarter{
                height: 50%;
                width: calc(24px * 3);
            }

            .quarter:not(:last-child){
                border-right: 1px solid var(--app-background-color-dark);
            }

            .futur-block{
                min-width: calc(24px * 4);
                width: calc(24px * 4);
                display: flex;
                flex-flow: row wrap;
                align-items: center;
                justify-content: center;
            }

            .btn-left, .btn-right{
                display: flex;
                flex-flow: row wrap;
                align-items: center;
                height: 48px;
                width: 10%;
                flex-grow: 1;
            }

            .btn-left{
                justify-content: flex-end;
            }

            .btn-right{
                justify-content: flex-start;
            }

            .medication-category{
                display:flex;
                flex-flow: row nowrap;
                align-items: center;
                justify-content: space-between;
                color: var(--app-text-color);
                font-size: 10px;
                border-bottom: 1px solid var(--app-background-color-dark);
            }

            .medication-category span:first-child{
                width: 10%;
                flex-grow: 1;
                padding-left: 8px;
                display:block;
                height: 100%;
                box-sizing: border-box;
            }

            .medication-category span:nth-child(2){
                max-width: calc(24px * 36 + 2px);
                width: calc(24px * 36 + 2px);
                display:block;
                height: 20px;
                box-sizing: border-box;
                border-left: 1px solid var(--app-background-color-dark);
                border-right: 1px solid var(--app-background-color-dark);
            }

            .medication-category span:last-child{
                width: 10%;
                flex-grow: 1;
                display:block;
                height: 100%;
                box-sizing: border-box;
            }

            .medication-line{
                display: flex;
                flex-flow: row nowrap;
                justify-content: space-between;
                width: 100%;
                align-items: center;
                height: 24px;
            }

            .medication-line:nth-child(even){
                background: #FAFAFA;
            }

            .medication-line .type{
                width: 10%;
                height: 100%;
                text-align: left;
                flex-grow: 1;
                padding-left: 8px;
            }

            .medication-line .extra-info{
                width: 10%;
                flex-grow: 1;
                padding: 0 8px;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
                height: 100%;
            }

            .medication-line .line-container{
                max-width: calc(24px * 36 + 2px);
                width: calc(24px * 36 + 2px);
                overflow: hidden;
                height: 24px;
                border-left: 1px solid var(--app-background-color-dark);
                border-right: 1px solid var(--app-background-color-dark);
            }

            .medication-line .line{
                display: flex;
                box-sizing: unset;
                position: absolute;
                color: #fff;
                border-radius: 2px;
                top: 0;
                left: 0;
                height: 100%;
                flex-flow: row wrap;
                align-items: center;
                justify-content: space-between;
                margin: 1px 0;
            }

            .medication-line .line::after{
                position: absolute;
                height: 100%;
                width: 100%;
                display: block;
                content:'';
                z-index: 0;
            }

            .medication-line .line.over{
                opacity: 0.6;
            }

            .line-total-width{
                position: relative;
                height: 100%;
            }

            .medication-line .line .name{
                text-align: left;
                margin-left: 4px;
                margin-bottom: 4px;
                z-index: 1;
                max-width: 100%;
                overflow: hidden;
                text-overflow: ellipsis;
                padding-right: 4px;
            }

            .medication-line .line .until{
                text-align: right;
                margin-right: 4px;
                margin-bottom: 4px;
                z-index: 1;
            }

            .medication-line .reimbursement-line{
                display: block;
                position: absolute;
                width: 100%;
                background: var(--app-status-color-ok);
                height: 4px;
                bottom: 0;
                transition: all .12s cubic-bezier(0.075, 0.82, 0.165, 1);
                cursor: pointer;
                overflow: visible;
            }

            .medication-line .reimbursement-line:hover{
                height: 6px;
            }

            paper-tooltip{
                --paper-tooltip: {
                    position: fixed;
                    z-index: 900;
                    width: auto;
                    left: 50%;
                    top: calc(10% + 24px);
                    transform: translate(-50%, -50%);
                    box-sizing: border-box;
                }
            }

            .medIcon{
                height: 28px;
                width: 28px;
            }

            .content{
                padding: 0;
            }

            .chronicIcon{
                height: 12px;
                width: 12px;
            }

            .suspensionIcon{
                height: 12px;
                width: 12px;
                color: var(--app-status-color-pending)
            }

            .legend-chronicIcon{
                height: 18px;
                width: 18px;
            }

            .legend-suspensionIcon{
                height: 18px;
                width: 18px;
                color: var(--app-status-color-pending)
            }

            .legend-line{
                margin-right: 10px;
            }

            .bold{
                font-weight: bold;
            }

            paper-tooltip{
                --paper-tooltip-delay-in:100;
                display: inline-block;
                position: absolute;
            }

            #medicationDetailDialog{
                height: 400px;
                width: 700px;
            }

            .modal-title{
                background:  var(--app-background-color-dark);
                margin-top: 0;
                padding-left: 24px;
            }

            .buttons{
                position: absolute;
                right: 0;
                bottom: 0;
                margin: 8px 16px;
            }

            .medicationDetailDialogContent{
                height: 400px;
                width: auto;
                margin: 1%;
            }

            .medication-detail-line{
                display: flex;
            }


            .flex{
                display: flex;
            }

            .pointer{
                cursor: pointer;
            }


        </style>

        <div class="content">
            <div id="legend">
                <span class="legend-line bold">[[localize('legend', 'Legend', language)]]: </span>
                <span class="legend-line bold"><iron-icon class="legend-chronicIcon" icon="icons:alarm-on"></iron-icon> [[localize('hub-chron-med', 'Chronic medication', language)]]</span>
                <span class="legend-line bold"><iron-icon class="legend-suspensionIcon" icon="icons:warning"></iron-icon> [[localize('hub-sus-med', 'Suspended medication', language)]]</span>
            </div>
            <div class="present">
                <div class="table">
                    <div class="tr th">
                        <div class="td reimbursed">

                        </div>
                        <div class="td"
                             style="flex-grow: 5;">

                        </div>
                        <div class="td" style="flex-grow: 2;">

                        </div>
                        <div class="td span-3" style="flex-grow: 3;">
                            <span>[[localize('mom_break','Breakfast',language)]]</span>
                        </div>
                        <div class="td span-3" style="flex-grow: 3;">
                            <span>[[localize('mom_lunch','Lunch',language)]]</span>
                        </div>
                        <div class="td span-3" style="flex-grow: 3;">
                            <span>[[localize('mom_dinner','Dinner',language)]]</span>
                        </div>
                        <div class="td" style="flex-grow: 4;">

                        </div>
                        <div class="td" style="flex-grow: 4;">

                        </div>
                    </div>
                    <div class="tr th">
                        <div class="td">

                        </div>
                        <div class="td td--medicine"
                             style="flex-grow: 5; justify-content: flex-start">
                            <span class="left">[[localize('medic','Medicine',language)]]</span>
                        </div>
                        <div class="td" style="flex-grow: 2;">
                            <span>[[localize('freq','Frequency',language)]]</span>
                        </div>
                        <div class="td bf-bef">
                            <span>[[localize('mom_before_short','Be',language)]]</span>
                        </div>
                        <div class="td bf-dur">
                            <span>[[localize('mom_during_short','Du',language)]]</span>
                        </div>
                        <div class="td bf-aft">
                            <span>[[localize('mom_after_short','Af',language)]]</span>
                        </div>
                        <div class="td lu-bef">
                            <span>[[localize('mom_before_short','Be',language)]]</span>
                        </div>
                        <div class="td lu-dur">
                            <span>[[localize('mom_during_short','Du',language)]]</span>
                        </div>
                        <div class="td lu-aft">
                            <span>[[localize('mom_after_short','Af',language)]]</span>
                        </div>
                        <div class="td di-bef">
                            <span>[[localize('mom_before_short','Be',language)]]</span>
                        </div>
                        <div class="td di-dur">
                            <span>[[localize('mom_during_short','Du',language)]]</span>
                        </div>
                        <div class="td di-aft">
                            <span>[[localize('mom_after_short','Af',language)]]</span>
                        </div>
                        <div class="td" style="flex-grow: 2;">
                            <span>[[localize('start-date','Start Date',language)]]</span>
                        </div>
                        <div class="td" style="flex-grow: 2;">
                            <span>[[localize('endDate','End Date',language)]]</span>
                        </div>
                        <div class="td td-comments" style="flex-grow: 4; justify-content: space-between;">
                            <span class="left">[[localize('com','Comments',language)]]</span>
                        </div>
                    </div>
                    <!-- END HEADER -->
                    <!-- START BODY -->

                    <template is="dom-repeat" items="[[currentMedicationScheme.msElems]]" as="medicationsWithPosology">
                        <div class$="tr [[_medicationClass(m.medication)]] pointer" data-medication$=[[medicationsWithPosology]] on-tap="_showMedication">
                            <div class="td reimbursed">
                                <template is="dom-if" if="[[_isChronic(medicationsWithPosology)]]">
                                    <iron-icon class="legend-chronicIcon" icon="icons:alarm-on"></iron-icon>
                                </template>
                                <template is="dom-if" if="[[_isSuspensions(medicationsWithPosology)]]">
                                    <iron-icon class="legend-suspensionIcon" title="[[_getReasonOfSuspension(medicationsWithPosology)]]" icon="icons:warning"></iron-icon>
                                </template>
                            </div>
                            <div class="td td--medicine" style="flex-grow: 5;">
                                <span class="left">[[_getMedicationName(medicationsWithPosology)]]</span>
                            </div>
                            <div class="td" style="flex-grow: 2;"><span>[[_getPosology(medicationsWithPosology)]]</span></div>
                            <template is="dom-repeat" items="" as="regimen">
                                <div class="td td-input bf-bef">
                                    <span></span>
                                </div>
                            </template>
                            <div class="td td-input bf-bef">[[_getRegiment(medicationsWithPosology, 0)]]</div>
                            <div class="td td-input bf-dur">[[_getRegiment(medicationsWithPosology, 1)]]</div>
                            <div class="td td-input bf-aft">[[_getRegiment(medicationsWithPosology, 2)]]</div>
                            <template is="dom-repeat" items="" as="regimen">
                                <div class="td td-input bf-bef">
                                    <span></span>
                                </div>
                            </template>
                            <div class="td td-input lu-bef">[[_getRegiment(medicationsWithPosology, 3)]]</div>
                            <div class="td td-input lu-dur">[[_getRegiment(medicationsWithPosology, 4)]]</div>
                            <div class="td td-input lu-aft">[[_getRegiment(medicationsWithPosology, 5)]]</div>
                            <template is="dom-repeat" items="" as="regimen">
                                <div class="td td-input bf-bef">
                                    <span></span>
                                </div>
                            </template>
                            <div class="td td-input di-bef">[[_getRegiment(medicationsWithPosology, 6)]]</div>
                            <div class="td td-input di-dur">[[_getRegiment(medicationsWithPosology, 7)]]</div>
                            <div class="td td-input di-aft">[[_getRegiment(medicationsWithPosology, 8)]]</div>
                            <template is="dom-repeat" items="" as="regimen">
                                <div class="td td-input bf-bef">
                                    <span></span>
                                </div>
                            </template>
                            <div class="td" style="flex-grow: 2;"><span>[[_getDateFromHub(medicationsWithPosology.beginmoment)]]</span></div>
                            <div class="td" style="flex-grow: 2;"><span>[[_getDateFromHub(medicationsWithPosology.endmoment)]]</span></div>
                            <div class="td td--comments" style="flex-grow: 4;"><span class="left">[[_getComment(medicationsWithPosology)]]</span></div>
                        </div>
                    </template>
                </div>
                <!-- END BODY -->
                <!-- END TABLE -->
            </div>
        </div>

        <paper-dialog id="medicationDetailDialog" no-cancel-on-outside-click no-cancel-on-esc-key>
            <div class="modal-title">
                [[_getMedicationName(selectedMedication)]]

                <template is="dom-if" if="[[_isChronic(selectedMedication)]]">
                   <div>
                       <iron-icon class="legend-chronicIcon" icon="icons:alarm-on"></iron-icon> [[localize('hub-chron-med', 'Chronic medication', language)]]
                   </div>
                </template>
                <template is="dom-if" if="[[_isSuspensions(selectedMedication)]]">
                    <div>
                        <iron-icon class="legend-suspensionIcon" icon="icons:warning"></iron-icon> [[localize('hub-sus-med', 'Suspended medication', language)]]
                    </div>
                </template>
            </div>
            <div class="medicationDetailDialogContent">
                <div>
                    <b>Date de traitement:</b> du [[_getDateFromHub(selectedMedication.beginmoment)]] au [[_getDateFromHub(selectedMedication.endmoment)]]
                </div>
                <div>
                    <b>[[localize('com','Comment',language)]]:</b> [[_getComment(selectedMedication)]]
                </div>
               <template is="dom-if" if="[[_isSuspensions(selectedMedication)]]">
                   <div>
                       <b>[[localize('hub-medic-susp-res','Suspension reason',language)]]:</b> [[_getReasonOfSuspension(selectedMedication)]]
                   </div>
               </template>
            </div>
            <div class="buttons">
                <paper-button class="modal-button" on-tap="_closeMedicationDetailDialog"><iron-icon icon="icons:close" class="mr5 smallIcon" ></iron-icon> [[localize('clo','Close',language)]]</paper-button>
            </div>
        </paper-dialog>

    </template>
    <script>
        import * as models from 'icc-api/dist/icc-api/model/models';
        import moment from 'moment/src/moment';

        class HtPatHubMedicationSchemeView extends Polymer.TkLocalizerMixin(Polymer.Element) {
            static get is() {
                return 'ht-pat-hub-medication-scheme-view';
            }

            static get properties() {
                return {
                    api: {
                        type: Object,
                        value: null
                    },
                    user: {
                        type: Object,
                        value: null
                    },
                    patient:{
                        type: Object
                    },
                    language: {
                        type: String
                    },
                    currentMedicationScheme:{
                        type: Object,
                        value: () => {}
                    },
                    periodicity:{
                        type: Object,
                        value: [
                            {code : 'D', label: {fr:'/jour'}},
                            {code : 'DA', label: {fr:'/8 jours'}},
                            {code : 'DD', label: {fr:'/3 jours'}},
                            {code : 'DE', label: {fr:'/11 jours'}},
                            {code : 'DN', label: {fr:'/9 jours'}},
                            {code : 'DQ', label: {fr:'/5 jours'}},
                            {code : 'DT', label: {fr:'/2 jours'}},
                            {code : 'DV', label: {fr:'/4 jours'}},
                            {code : 'DW', label: {fr:'/12 jours'}},
                            {code : 'DX', label: {fr:'/10 jours'}},
                            {code : 'DZ', label: {fr:'/6 jours'}},
                            {code : 'J', label: {fr:'/an'}},
                            {code : 'JD', label: {fr:'/3 ans'}},
                            {code : 'JH2', label: {fr:'/6 mois'}},
                            {code : 'JQ', label: {fr:'/5 ans'}},
                            {code : 'JT', label: {fr:'/2 ans'}},
                            {code : 'JV', label: {fr:'/4 ans'}},
                            {code : 'JZ', label: {fr:'/6 ans'}},
                            {code : 'M', label: {fr:'/mois'}},
                            {code : 'MA', label: {fr:'/8 mois'}},
                            {code : 'MC', label: {fr:'/18 mois'}},
                            {code : 'MD', label: {fr:'/3 mois'}},
                            {code : 'ME', label: {fr:'/11 mois'}},
                            {code : 'MN', label: {fr:'/9 mois'}},
                            {code : 'MQ', label: {fr:'/5 mois'}},
                            {code : 'MS', label: {fr:'/7 mois'}},
                            {code : 'MT', label: {fr:'/2 mois'}},
                            {code : 'MV', label: {fr:'/4 mois'}},
                            {code : 'MX', label: {fr:'/10 mois'}},
                            {code : 'MZ2', label: {fr:'/6 mois'}},
                            {code : 'O1', label: {fr:'Tout les 2 jours'}},
                            {code : 'ondemand', label: {fr:'Sur demande'}},
                            {code : 'U', label: {fr:'/heure'}},
                            {code : 'UA', label: {fr:'/8 heures'}},
                            {code : 'UD', label: {fr:'/3 heures'}},
                            {code : 'UE', label: {fr:'/11 heures'}},
                            {code : 'UH', label: {fr:'/demi-heure'}},
                            {code : 'UN', label: {fr:'/9 heures'}},
                            {code : 'UQ', label: {fr:'/5 heures'}},
                            {code : 'US', label: {fr:'/7 heures'}},
                            {code : 'UT', label: {fr:'/2 heures'}},
                            {code : 'UV', label: {fr:'/4 heures'}},
                            {code : 'UW', label: {fr:'/12 heures'}},
                            {code : 'UX', label: {fr:'/10 heures'}},
                            {code : 'UZ', label: {fr:'/6 heures'}},
                            {code : 'W', label: {fr:'/semaine'}},
                            {code : 'WA', label: {fr:'/8 semaines'}},
                            {code : 'WD', label: {fr:'/3 semaines'}},
                            {code : 'WE', label: {fr:'/11 semaines'}},
                            {code : 'WN', label: {fr:'/9 semaines'}},
                            {code : 'WP', label: {fr:'/24 semaines'}},
                            {code : 'WQ', label: {fr:'/5 semaines'}},
                            {code : 'WS', label: {fr:'/7 semaines'}},
                            {code : 'WT', label: {fr:'/2 semaines'}},
                            {code : 'WV', label: {fr:'/4 semaines'}},
                            {code : 'WW', label: {fr:'/12 semaines'}},
                            {code : 'WX', label: {fr:'/10 semaines'}},
                            {code : 'WZ', label: {fr:'/6 semaines'}}
                        ]
                    },
                    selectedMedication: {
                        type: Object,
                        value: () => {}
                    }
                }
            }

            static get observers() {
                return ['dataProvider(currentMedicationScheme.*)'];
            }

            ready() {
                super.ready();
            }

            dataProvider(){
                this.set('selectedMedication', {})
                console.log(this.currentMedicationScheme)
            }

            _getMedicationName(medication){
                return medication && medication.medicinalproduct && medication.medicinalproduct.intendedname ? medication && medication.medicinalproduct && medication.medicinalproduct.intendedname :
                    medication && medication.substanceproduct && medication.substanceproduct.intendedname ? medication.substanceproduct.intendedname  :
                        medication && medication.compoundprescription !== null ? "Magistrale" : null


            }

            _getPosology(medication){
                const period = medication && medication.frequency && medication.frequency.periodicity && medication.frequency.periodicity.cd && medication.frequency.periodicity.cd.value || null
                const periodicity = this.periodicity.find(p => p.code === period) || null
                return periodicity && periodicity.label && periodicity.label[this.language] ? periodicity.label[this.language] : null
            }

            _convertHubDateAsString(timestamp){
                if(timestamp){
                    let date = parseInt(timestamp) / 1000000
                    return this.api.moment(date).format("DD/MM/YYYY")
                }
            }

            _getDateFromHub(date){
                return date && date.date ? this._convertHubDateAsString(date.date) : null
            }

            _getComment(medication){
                return medication && medication.posology && medication.posology.text && medication.posology.text.value || null
            }

            _isChronic(medication){
                return medication && medication.temporality && medication.temporality.cd && medication.temporality.cd.value === "CHRONIC" ? true : false
            }

            _getRegiment(medication, period){

                const concernPeriod = period === 0 ? "beforebreakfast" :
                    period === 1 ? "duringbreakfast" :
                    period === 2 ? "afterbreakfast" :
                    period === 3 ? "beforelunch" :
                    period === 4 ? "duringlunch" :
                    period === 5 ? "afterlunch" :
                    period === 6 ? "beforediner" :
                    period === 7 ? "duringdiner" :
                    period === 8 ? "afterdiner" : null

                const regimen = medication && medication.regimen && medication.regimen.daynumbersAndQuantitiesAndDates || []
                const regimenQty = regimen.filter(r => _.toLower(r.value && r.value.dayperiod && r.value.dayperiod.cd && r.value.dayperiod.cd.value) === concernPeriod) || []

                return regimenQty && regimenQty.length || null

            }

            _isSuspensions(medication){
                return medication && medication.suspended === true ? true : false
            }

            _getReasonOfSuspension(medication){
                return _.flatten(medication && medication.suspensions && medication.suspensions.map(s => s && s.reasonTexts && s.reasonTexts.map(r => r && r.value))).join(',') || null
            }

            _showMedication(e){
                this.set('selectedMedication', {})
                if(e.currentTarget.dataset.medication){
                    this.set('selectedMedication', JSON.parse(e.currentTarget.dataset.medication))
                    this.$['medicationDetailDialog'].open()
                }
            }

            _closeMedicationDetailDialog(){
                this.set('selectedMedication', {})
                this.$['medicationDetailDialog'].close()
            }

        }
        customElements.define(HtPatHubMedicationSchemeView.is, HtPatHubMedicationSchemeView);
    </script>
</dom-module>
