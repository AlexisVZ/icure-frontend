<link rel="import" href="../../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../../bower_components/vaadin-icons/vaadin-icons.html">
<link rel="import" href="../../../../../bower_components/vaadin-material-theme/vaadin-date-picker.html">
<link rel="import" href="../../../../../bower_components/vaadin-material-theme/vaadin-text-field.html">
<link rel="import" href="../../../../../bower_components/vaadin-material-theme/vaadin-checkbox.html">
<link rel="import" href="../../../../../bower_components/vaadin-date-picker/vaadin-date-picker.html">
<link rel="import" href="../../../../../bower_components/vaadin-form-layout/vaadin-form-layout.html">
<link rel="import" href="../../../../../bower_components/vaadin-combo-box/vaadin-combo-box.html">
<link rel="import" href="../../../../../bower_components/vaadin-text-field/vaadin-text-area.html">
<link rel="import" href="../../../../../bower_components/vaadin-checkbox/vaadin-checkbox.html">
<link rel="import" href="../../../../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../../../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="../../../dynamic-form/dynamic-link.html">
<link rel="import" href="../../../dynamic-form/dynamic-pills.html">
<link rel="import" href="../../../ht-spinner/ht-spinner.html">
<link rel="import" href="../../../dynamic-form/dynamic-doc.html">

<dom-module id="ht-pat-hub-transaction-view">
    <template>
        <style>

            #dialog .hub-cons{
                display: flex;
                flex-flow: row wrap;
                align-items: center;
                justify-content: flex-start;
                width: 100%;
                box-sizing: border-box;
            }

            #dialog paper-button.action {
                --paper-button-ink-color: var(--app-secondary-color-dark);
                font-weight: 400;
                font-size: 12px;
                height: 32px;
                padding: 10px 1.2em;
                box-shadow: var(--shadow-elevation-2dp_-_box-shadow);
                background: var(--app-secondary-color);
                color: var(--app-primary-color-dark);
                justify-self: flex-end;
            }
            #dialog .hub-cons paper-button.action[disabled] {
                background-color: var(--app-secondary-color-dark);
                color: var(--app-text-color-disabled);
                box-shadow: none;
            }

            #dialog .hub-cons .buttons {
                right: 24px;
                position: absolute;
            }

            #dialog .hub-cons vaadin-date-picker {
                margin-right: 8px;
            }

            #dialog a {
                text-decoration: none;
                color:	var(--app-secondary-color);
            }

            #dialog{
                min-height: 800px;
                min-width: 1024px;
            }

            #dialog .hub-doc {
                overflow: auto ;
                max-height: 500px;
            }

            .links {
                position: absolute;
                right: 0;
            }

            .pills {
                float: right;
            }

            dynamic-link {
                float: right;
                top:4px;
            }

            vaadin-combo-box {
                width: 100%;
            }

            vaadin-text-area {
                width: 100%;
            }

            .containerHubCons {
                height: 58px;
                display: flex;
            }

            #par-search {
                flex: 1;
            }

            #dialog .hub-info{
                margin-top:0;
                display:flex;
                flex-flow: row nowrap;
                justify-content: flex-start;
                align-items: flex-start;
            }

            #dialog .hub-info div{
                margin-right: 24px;
            }

            #dialog .hub-info div p{
                margin: 8px 0;
            }

            #dialog .hub-info div b{
                margin-right: 8px;
            }

            .modal-title{
                background:  var(--app-background-color-dark);
                margin-top: 0;
                padding: 16px 24px;
            }

            paper-tabs {
                --paper-tabs-selection-bar-color: var(--app-secondary-color);
            }

            paper-tab {
                --paper-tab-ink: var(--app-secondary-color);
            }

            paper-tab.iron-selected {
                font-weight: bold;
            }

            paper-tab.iron-selected > iron-icon {
                color: var(--app-secondary-color);
            }

            .tab-selector {
                border-bottom: 1px solid var(--app-background-color-dark);
            }

            .end-buttons {
                display: flex;
                position: absolute;
                right: 0;
                bottom: 0;
            }

            .modal-button--save {
                background: var(--app-secondary-color);
                box-shadow: var(--shadow-elevation-2dp_-_box-shadow);
            }

            ht-spinner {
                position: relative;
                height: 42px;
                width: 42px;
            }

            #kmehr_slot{
                overflow-y: scroll;
                height: 90%;
            }

            #titleInfo{
                height: 20px;
                width: 98%;
                margin: 1%;
                font-size: 20px;
                font-weight: bold;
            }

            .headerInfo{
                height: auto;
                width: 98%;
                margin: 1%;
                border: 1px solid #c5c5c5;
                border-top: 4px solid var(--app-secondary-color-dark);
            }

            #blockInfo{
                height: 100px;
                width: 100%;
                margin: 1%;
            }

            .headerInfoLine{
                height: 20px;
                width: 100%;
                margin: 1%;
                display: flex;
            }

            .headerInfoField{
                display: flex;
                flex-direction: row;
                flex-wrap: nowrap;
                align-items: center;
                align-content: stretch;
                width: 32%;
                margin-left: 1%;
            }

            .headerLabel{
                font-weight: bold;
            }

            .headerMasterTitle{
                font-size: 16px;
            }

            .blockInfo{
                height: auto;
                width: 98%;
                margin: 1%;
                border: 1px solid #c5c5c5;
                border-top: 4px solid var(--app-secondary-color-dark);
            }

            .vaadinStyle{
                height: auto;
            }

            .doNotDisplay {
                display: none;
            }

            .pageContent{
                margin: 1%;
                width: auto;
            }

            iron-pages{
                height: 92%;
                width: auto;
                overflow: auto;
            }

            .modal-title {
                background: var(--app-background-color-dark);
                margin-top: 0;
                padding: 16px 24px;
            }

            .modal-button{
                --paper-button-ink-color: var(--app-secondary-color);
                background-color: var(--app-secondary-color);
                color: var(--app-text-color);
                font-weight: 700;
                font-size: 14px;
                height: 40px;
                min-width: 100px;
                padding: 10px 1.2em;
            }

            .selectedDocumentToImportContent{
                height: 260px;
                width: auto;
                margin: 1%;
            }

            .buttons{
                position: absolute;
                right: 0;
                bottom: 0;
                margin: 8px 16px;
            }

            #importHubDocumentDialog{
                height: 400px;
                width: 650px;
            }

        </style>

            <!--<h2 class="modal-title">[[localize('hub_doc','Document',language)]]:[[_transactionId(transInfo)]]:[[_transactionType(transInfo)]]</h2>-->
            <paper-tabs class="tab-selector" selected="{{tabs}}" >
                <paper-tab>[[localize('tra_vwr','Viewer',language)]]</paper-tab>
                <paper-tab class="doNotDisplay" id="tabAttachments">[[_getAttachmentCount(attachmentCount)]] [[localize('att','Attachments',language)]]</paper-tab>
                <paper-tab>[[localize('trans_acc_tra','Trace',language)]]</paper-tab>
                <paper-tab>[[localize('json_vwr','JSON View',language)]]</paper-tab>
            </paper-tabs>
            <iron-pages selected="[[tabs]]">
                <page>
                    <div class="pageContent">
                        <div id="titleInfo">
                            [[_transactionType(transInfo)]]
                        </div>
                        <div class="hub-doc">
                            <template is="dom-repeat" items="[[message.folders]]" as="folder">
                                <div class="headerMasterTitle headerLabel">[[localize('hub_pat','First name',language)]]</div>
                                <div class="headerInfo">
                                    <div class="headerInfoLine">
                                        <div class="headerInfoField"><span class="headerLabel">[[localize('hub_las_nam','Last name',language)]]: </span> [[folder.patient.familyname]]</div>
                                        <div class="headerInfoField"><span class="headerLabel">[[localize('hub_bir_dat','Birth date',language)]]: </span> [[dateFormat(folder.patient.birthdate)]]</div>
                                        <div class="headerInfoField"><span class="headerLabel">[[localize('hub_adr','Adress',language)]]: </span> </div>
                                    </div>
                                    <div class="headerInfoLine">
                                        <div class="headerInfoField"><span class="headerLabel">[[localize('hub_fir_nam','First name',language)]]: </span> [[folder.patient.firstnames.0]] ([[folder.patient.sex.value]])</div>
                                        <div class="headerInfoField"><span class="headerLabel">[[localize('hub_inss','Inss',language)]]: </span> </div>
                                        <div class="headerInfoField"><span class="headerLabel">[[localize('hub_loc','Locality',language)]]: </span> </div>
                                    </div>
                                </div>


                                <template is="dom-repeat" items="[[folder.transactions]]" as="trn">
                                    <template is="dom-if" if="[[_isAuthor(trn.author.hcparties)]]">
                                        <div class="headerMasterTitle headerLabel">[[localize('hub_auth','Author(s)',language)]]</div>
                                        <template is="dom-repeat" items="[[_getHcpInfo(trn.author.hcparties)]]" as="hcp">
                                            <div class="headerInfo">
                                                <div class="headerInfoLine">
                                                    <div class="headerInfoField"><span class="headerLabel">[[localize('hub_las_nam','Last name',language)]]: </span> [[hcp.name]] [[hcp.familyName]]</div>
                                                    <div class="headerInfoField"><span class="headerLabel">[[localize('hub_hcp_type','Type',language)]]: </span> [[hcp.type]]</div>
                                                    <div class="headerInfoField"><span class="headerLabel">[[localize('hub_adr','Adress',language)]]: </span></div>
                                                </div>
                                                <div class="headerInfoLine">
                                                    <div class="headerInfoField"><span class="headerLabel">[[localize('hub_fir_nam','First name',language)]]: </span> [[hcp.firstName]]</div>
                                                    <div class="headerInfoField"><span class="headerLabel">[[localize('hub_inss','Inss',language)]]: </span> [[hcp.inss]]</div>
                                                    <div class="headerInfoField"><span class="headerLabel">[[localize('hub_nihii','Nihii',language)]]: </span> [[hcp.nihii]]</div>
                                                </div>
                                            </div>
                                        </template>
                                    </template>
                                    <template is="dom-if" if="[[_isRedactor(trn.redactor.hcparties)]]">
                                        <div class="headerMasterTitle headerLabel">[[localize('hub_redact','Redactor(s)',language)]]</div>
                                        <template is="dom-repeat" items="[[_getHcpInfo(trn.redactor.hcparties)]]" as="hcp">
                                            <div class="headerInfo">
                                                <div class="headerInfoLine">
                                                    <div class="headerInfoField"><span class="headerLabel">[[localize('hub_las_nam','Last name',language)]]: </span> [[hcp.name]] [[hcp.familyName]]</div>
                                                    <div class="headerInfoField"><span class="headerLabel">[[localize('hub_hcp_type','Type',language)]]: </span> [[hcp.type]]</div>
                                                    <div class="headerInfoField"><span class="headerLabel">[[localize('hub_adr','Adress',language)]]: </span></div>
                                                </div>
                                                <div class="headerInfoLine">
                                                    <div class="headerInfoField"><span class="headerLabel">[[localize('hub_fir_nam','First name',language)]]: </span> [[hcp.firstName]]</div>
                                                    <div class="headerInfoField"><span class="headerLabel">[[localize('hub_inss','Inss',language)]]: </span> [[hcp.inss]] </div>
                                                    <div class="headerInfoField"><span class="headerLabel">[[localize('hub_nihii','Nihii',language)]]: </span> [[hcp.nihii]] </div>
                                                </div>
                                            </div>
                                        </template>
                                    </template>
                                    <template is="dom-if" if="[[_isSumehrType(transInfo)]]">
                                        <template is="dom-repeat" items="[[_processItem(trn.item)]]" as="item">
                                            <div class="headerMasterTitle headerLabel">[[_getTraduction(item.0.type)]]</div>
                                            <div class="blockInfo">
                                                <template is="dom-if" if="[[_ifTableView(item.0.type)]]">
                                                    <vaadin-grid class="vaadinStyle" items="[[item]]">
                                                        <vaadin-grid-column>
                                                            <template class="header">
                                                                <vaadin-checkbox></vaadin-checkbox>
                                                            </template>
                                                            <template>
                                                                <vaadin-checkbox></vaadin-checkbox>
                                                            </template>
                                                        </vaadin-grid-column>
                                                        <vaadin-grid-column>
                                                            <template class="header">
                                                                [[localize('hub_titl','Title',language)]]
                                                            </template>
                                                            <template>
                                                                [[_getTitle(item.contents, item.type)]]
                                                            </template>
                                                        </vaadin-grid-column>
                                                        <vaadin-grid-column>
                                                            <template class="header">
                                                                [[localize('hub_sta_dat','Start date',language)]]
                                                            </template>
                                                            <template>
                                                                [[_convertHubDateAsString(item.beginMoment)]]
                                                            </template>
                                                        </vaadin-grid-column>
                                                        <vaadin-grid-column>
                                                            <template class="header">
                                                                [[localize('hub_end_dat','End date',language)]]
                                                            </template>
                                                            <template>
                                                                [[_convertHubDateAsString(item.endMoment)]]
                                                            </template>
                                                        </vaadin-grid-column>
                                                        <vaadin-grid-column>
                                                            <template class="header">
                                                                [[localize('hub_code','Code',language)]]
                                                            </template>
                                                            <template>
                                                                <template is="dom-repeat" items="[[_getCode(item.contents, item.type)]]" as="code">
                                                                    [[code.code]] [[code.value]]<br/>
                                                                </template>
                                                            </template>
                                                        </vaadin-grid-column>
                                                    </vaadin-grid>
                                                </template>
                                                <template is="dom-if" if="[[!_ifTableView(item.0.type)]]">
                                                    <template is="dom-repeat" items="[[item]]" as="item">
                                                        <template is="dom-if" if="[[_isHcp(item.type)]]">
                                                            <template is="dom-repeat" items="[[item.contents]]" as="content">
                                                                <template is="dom-repeat" items="[[content.authors]]" as="hcp">
                                                                    <div class="headerInfoLine">
                                                                        <div class="headerInfoField"><span class="headerLabel">[[localize('hub_las_nam','Last name',language)]]: </span> [[hcp.name]] [[hcp.familyName]]</div>
                                                                        <div class="headerInfoField"><span class="headerLabel">[[localize('hub_hcp_type','Type',language)]]: </span> [[hcp.type]]</div>
                                                                        <div class="headerInfoField"><span class="headerLabel">[[localize('hub_adr','Adress',language)]]: </span></div>
                                                                    </div>
                                                                    <div class="headerInfoLine">
                                                                        <div class="headerInfoField"><span class="headerLabel">[[localize('hub_fir_nam','First name',language)]]: </span> [[hcp.firstName]]</div>
                                                                        <div class="headerInfoField"><span class="headerLabel">[[localize('hub_inss','Inss',language)]]: </span> [[hcp.inss]] </div>
                                                                        <div class="headerInfoField"><span class="headerLabel">[[localize('hub_nihii','Nihii',language)]]: </span> [[hcp.nihii]] </div>
                                                                    </div>
                                                                </template>
                                                            </template>
                                                        </template>
                                                        <template is="dom-if" if="[[_isPerson(item.type)]]">
                                                            <template is="dom-repeat" items="[[item.contents]]" as="content">
                                                                <template is="dom-repeat" items="[[content.persons]]" as="person">
                                                                    <div class="headerInfoLine">
                                                                        <div class="headerInfoField"><span class="headerLabel">[[localize('hub_las_nam','Last name',language)]]: </span> [[person.name]] [[person.familyName]]</div>
                                                                        <div class="headerInfoField"><span class="headerLabel">[[localize('hub_hcp_type','Type',language)]]: </span> [[person.type]]</div>
                                                                        <div class="headerInfoField"><span class="headerLabel">[[localize('hub_adr','Adress',language)]]: </span></div>
                                                                    </div>
                                                                    <div class="headerInfoLine">
                                                                        <div class="headerInfoField"><span class="headerLabel">[[localize('hub_fir_nam','First name',language)]]: </span> [[person.firstName]]</div>
                                                                        <div class="headerInfoField"><span class="headerLabel">[[localize('hub_inss','Inss',language)]]: </span> [[person.inss]] </div>
                                                                        <div class="headerInfoField"><span class="headerLabel">[[localize('hub_nihii','Nihii',language)]]: </span> [[person.nihii]] </div>
                                                                    </div>
                                                                </template>
                                                            </template>
                                                        </template>
                                                        <template is="dom-if" if="[[isPerson(item.0.type)]]">

                                                        </template>
                                                    </template>
                                                </template>
                                            </div>
                                        </template>
                                    </template>
                                </template>
                            </template>
                        </div>
                    </div>
                </page>
                <page>
                    <div class="pageContent">
                        <div class="hub-doc">
                            <!--                    <div class="headerMasterTitle headerLabel">[[localize('hub_pat','First name',language)]]</div>-->
                            <template is="dom-if" if="[[!_isSumehrType(transInfo)]]">
                                <template is="dom-repeat" items="[[message.folders]]" as="folder">
                                    <template is="dom-repeat" items="[[folder.transactions]]" as="trn">
                                        <template is="dom-repeat" items="[[_txtsWithCnt(trn)]]" as="txt">
                                            <p>[[_textData(txt.value)]]</p>
                                        </template>
                                        <template is="dom-repeat" items="[[_textsWithLayoutWithCnt(trn)]]" as="ftxt">
                                            <dynamic-doc api="[[api]]" user="[[user]]" patient="[[patient]]" data="[[_textWithLayoutData(ftxt)]]" i18n="[[i18n]]" language="[[language]]"
                                                         resources="[[resources]]" title="[[lnk.mediatype]]" downloadable="true" preview="true" is-pat-detail="false"></dynamic-doc>
                                           <!-- <paper-button class="modal-button" on-tap="_importDocumentIntoPatient" data-item$=[[ftxt]]><iron-icon icon="icons:assignment-returned" class="mr5 smallIcon" ></iron-icon> [[localize('imp-pat','Import',language)]]</paper-button>-->
                                        </template>
                                        <template is="dom-repeat" items="[[_lnksWithCnt(trn)]]" as="lnk">
                                            <dynamic-doc api="[[api]]" user="[[user]]" patient="[[patient]]" data="[[_linkData(lnk)]]" i18n="[[i18n]]" language="[[language]]"
                                                         resources="[[resources]]" title="[[lnk.mediatype]]" downloadable="true" preview="true" is-pat-detail="false"></dynamic-doc>
                                            <paper-button class="modal-button" on-tap="_importDocumentIntoPatientDialog" data-document$=[[lnk]] data-transaction$="[[trn]]"><iron-icon icon="icons:assignment-returned" class="mr5 smallIcon" ></iron-icon> [[localize('imp-pat','Import',language)]]</paper-button>
                                        </template>
                                    </template>
                                </template>
                            </template>
                        </div>
                    </div>
                </page>
                <page>
                    <div class="hub-cons"> <!-- Notification input -->
                        <div>
                            [[auditTrail]]
                        </div>

                    </div>
                </page>
                <page>
                    <div class="pageContent">
                        <div class="hub-cons"> <!-- Notification input -->
                            <div>
                                <iron-autogrow-textarea class="paper-input-input" slot="input" id="transactionText" value="[[getJSON(message)]]" ></iron-autogrow-textarea>
                            </div>

                        </div>
                    </div>
                </page>
            </iron-pages>

        <paper-dialog id="importHubDocumentDialog">
            <div class="modal-title">
                [[localize('imp-pat','Import document',language)]]
            </div>
            <div class="selectedDocumentToImportContent">
                <paper-input label="Document title" value="{{selectedDocumentToBeImported.title}}"></paper-input>
                <paper-input label="Document type" value="{{selectedDocumentToBeImported.docType}}"></paper-input>
            </div>
            <div class="buttons">
                <paper-button class="modal-button" on-tap="_importDocumentIntoPatient"><iron-icon icon="icons:cloud-download" class="mr5 smallIcon" ></iron-icon> [[localize('imp','Import',language)]]</paper-button>
                <paper-button class="modal-button" on-tap="_closeImportDialog"><iron-icon icon="icons:close" class="mr5 smallIcon" ></iron-icon> [[localize('clo','Close',language)]]</paper-button>
            </div>
        </paper-dialog>
    </template>
    <script>
        import * as models from 'icc-api/dist/icc-api/model/models';
        import moment from 'moment/src/moment';

        class HtPatHubTransactionViewSecond extends Polymer.TkLocalizerMixin(Polymer.mixinBehaviors([Polymer.IronResizableBehavior], Polymer.Element)) {
            static get is() {
                return 'ht-pat-hub-transaction-view';
            }

            static get properties() {
                return {
                    api: {
                        type: Object,
                        value: null
                    },
                    user: {
                        type: Object,
                        value: null
                    },
                    patient:{
                      type: Object
                    },
                    language: {
                        type: String
                    },
                    opened: {
                        type: Boolean,
                        value: false
                    },
                    tabs: {
                        type:  Number,
                        value: 0
                    },
                    isLoading:{
                        type: Boolean,
                        value: false
                    },
                    transInfo:{
                        type: Object,
                        value: null
                    },
                    message:{
                        type: Object,
                        value: null
                    },
                    attachmentCount: {
                        type:  Number,
                        value: 0
                    },
                    auditTrail:{
                        type: Object,
                        value: null
                    },
                    parent:{
                        type:Object,
                        value: null
                    },
                    selectedDocumentToBeImported:{
                        type: Object,
                        value: () => {}
                    },
                    currentContact:{
                        type: Object
                    },
                };
            }

            static get observers() {
                return ['apiReady(api,user,opened)'];
            }

            ready() {
                super.ready();
            }

            _dateFormat(date) {
                return date ? this.api.moment(date).format('DD/MM/YYYY') : '';
            }

            _textData(txt){
                if(txt){
                    console.log("text:", txt)
                    return txt
                }else{
                    return null
                }
            }

            _textWithLayoutData(ftxt){
                if(ftxt){
                    console.log("textWL:", ftxt)
                    return ftxt
                }else{
                    return null
                }
            }

            _linkData(lnk){
                if(lnk){
                    console.log("lnk:", lnk)
                    return lnk
                }else{
                    return null
                }
            }

            _yesOrNo(b){
                return b ? this.localize('yes','yes',this.language) : this.localize('no','no',this.language)
            }

            _lnks(trn) {
                let lnks = _.flatMap(trn.item || [], it => this._lnks(it)).concat(_.flatMap(trn.heading, it => this._lnks(it))).concat(_.flatMap(trn.lnk || [], it => it)).concat(_.flatMap(trn.lnks || [], it => it))
                return lnks
            }

            _lnksWithCnt(trn){
                let lnks = this._lnks(trn)
                this.set("attachmentCount", this.attachmentCount + lnks.length)
                return lnks;
            }

            _txts(trn) {
                let txts =_.flatMap(trn.item || [], it => this._txts(it)).concat(_.flatMap(trn.heading, it => this._txts(it))).concat(_.flatMap(trn.text || [], it => it)).concat(_.flatMap(trn.texts || [], it => it))
                return txts
            }

            _txtsWithCnt(trn){
                let txts = this._txts(trn)
                this.set("attachmentCount", this.attachmentCount + txts.length)
                return txts;
            }

            _textsWithLayout(trn) {
                //todo add mimetype + filename
                let txts = _.flatMap(trn.item || [], it => this._textsWithLayout(it)).concat(_.flatMap(trn.heading, it => this._textsWithLayout(it))).concat(_.flatMap(trn.textWithLayout || [], it => it))
                return txts
            }

            _textsWithLayoutWithCnt(trn){
                let txts = this._textsWithLayout(trn)
                this.set("attachmentCount", this.attachmentCount + txts.length)
                return txts;
            }

            _hasAttachments(cnt){
                return cnt && cnt > 0 ? true : false
            }

            _getAttachmentCount(cnt){
                if(this._hasAttachments(cnt)){
                    if (this.shadowRoot) this.shadowRoot.getElementById("tabAttachments").classList.remove("doNotDisplay")
                    this.set("tabs", 1);
                    this.set("tabs", 0);
                }else{
                    if (this.shadowRoot) this.shadowRoot.getElementById("tabAttachments").classList.add("doNotDisplay")
                    this.set("tabs", 0);
                }
                return cnt;
            }

            isEven(n) {
                return n % 2 == 0;
            }

            getGender(niss){
                if(niss && niss.length === 11){
                    const c9 = niss.substring(8,9);
                    const even = this.isEven(parseInt(c9));
                    if(even){
                        return 'female';
                    }
                    else{
                        return 'male';
                    }
                }
                else{
                    return '';
                }
            }


            apiReady() {
                if (!this.api || !this.user || !this.user.id || !this.opened) return;

                try {
                } catch (e) {
                    console.log(e);
                }
            }

            attached() {
                super.attached();
                this.async(this.notifyResize, 1);
            }


            open(htPatHubDetail, transInfo, tranRespPromise) {
                this.set('parent', htPatHubDetail)
                this.set('attachmentCount', 0);
                this.set('message', null);
                this.set('transInfo', transInfo);
                this.set('isLoading',true);
                this._getTrail(transInfo).then(trail => this.set('auditTrail',trail));
                if(tranRespPromise){
                    tranRespPromise.then(tranResp => {
                        this.set('message', tranResp);
                        this.set('isLoading',false);
                    }).catch( error=> {
                        this.set('message', null);
                        console.log('getTransaction failed : ' + error);
                        this.set('isLoading',false);
                    })
                }
            }

            getJSON(obj){
                return JSON.stringify(obj);
            }

            //getPatientAuditTrailUsingGET(
            // endpoint, xFHCKeystoreId, xFHCTokenId, xFHCPassPhrase,
            // hcpLastName, hcpFirstName, hcpNihii, hcpSsin, hcpZip,
            // hubPackageId, from, to,
            // authorNihii, authorSsin,
            // isGlobal, breakTheGlassReason, ssin, sv, sl, id)
            _getTrail(transaction){
                if (this.patient.ssin && this.api.tokenId) {
                    return this.api.hcparty().getHealthcareParty(this.user.healthcarePartyId)
                        .then(hcp =>
                            this.api.fhc().Hubcontroller().getPatientAuditTrailUsingGET(this.parent.hubEndPoint,
                                this.api.keystoreId, this.api.tokenId, this.api.credentials.ehpassword,
                                hcp.lastName, hcp.firstName, hcp.nihii, hcp.ssin, this.parent.hcpZip,
                                this.hubPackageId, null, null,
                                null, null,
                                true, this.breakTheGlassReason, null,
                                transaction.ids.find(id => id.s === 'LOCAL').sv, transaction.ids.find(id => id.s === 'LOCAL').sl, transaction.ids.find(id => id.s === 'LOCAL').value)
                        ).then(trailResp => {
                                if (trailResp) {
                                    return trailResp;
                                } else {
                                    return null;
                                }
                            }
                        ).catch(e => {console.log(e)})
                } else {
                    return Promise.resolve(null)
                }
            }

            saveMedicationSchemeAsDocument(transactionSetId, sXml){
                return this.api.document().newInstance(this.user, null, {documentType: 'medicationscheme', mainUti: "public.xml", name: "medicationscheme.xml"}).then(
                    doc => this.api.document().createDocument(doc)).then(
                    doc => this.api.document().setAttachment(doc.id, undefined, this.api.crypto().utils.ua2ArrayBuffer(this.api.crypto().utils.utf82ua(sXml))).then(() => doc)
                ).catch(error => console.log(error))
            }

            _getNodeList(msg, tagName){
                return msg ? msg.querySelectorAll(tagName) : null;
            }

            _getAuthorDesc(trn, type){
                const auth = this._getAuthor(trn, type);
                if(auth){
                    let nm = auth.querySelector('name') ? auth.querySelector('name').innerHTML : '';
                    nm += auth.querySelector('firstname') ? ' ' + auth.querySelector('firstname').innerHTML : ''
                    nm += auth.querySelector('familyname') ? ' ' + auth.querySelector('familyname').innerHTML : ''
                    return nm
                }else {
                    return '';
                }
            }

            _getAuthor(trn, type){
                //msg.querySelectorAll(tagName)[0].querySelectorAll('author')[0].querySelectorAll('hcparty')
                const hcps = Array.from(trn.querySelectorAll('author')[0].querySelectorAll('hcparty'));
                const auth =  hcps ? hcps.find(hcp => hcp.querySelectorAll('cd')[0].innerHTML === type) : null;
                return auth;
            }

            _isSumehr(transInfo){
                return this._transactionType(transInfo) === 'sumehr';
            }

            _isMedicationScheme(transInfo){
                return this._transactionType(transInfo) === 'medicationscheme';
            }

            _isDiaryNote(transInfo){
                return this._transactionType(transInfo) === 'diarynote';
            }

            _isOther(transInfo){
                return !( this._isSumehr(transInfo)|| this._isMedicationScheme(transInfo) || this._isDiaryNote(transInfo));
            }

            _transactionId(tr){
                if(tr && tr.ids){
                    const id = tr.ids.find(id => id.s === "LOCAL");
                    if(id){
                        return (id.sl ? id.sl : "") + "/" + (id.value ? id.value : "");
                    } else{
                        return "--";
                    }
                }else{
                    return "";
                }
            }

            _transactionDate(tr){
                if(tr && tr.date) {
                    var d = new Date(0);
                    d.setUTCMilliseconds(tr.date);
                    return d.toDateString();
                } else {
                    return "";
                }
            }

            dateFormat(date){
                if(date && date.date && date.date.millis){
                    let d = new Date(0);
                    d.setUTCMilliseconds(date.date.millis);
                    return d.toDateString();
                }else {
                    return ""
                }
            }

            _transactionAuthor(tr){
                if(tr){
                    var authorRes = "--";
                    const author = tr.author.hcparties.find(hcp => hcp.familyname);
                    if(author) {
                        authorRes = author.familyname + ' ' + author.firstname;
                    }
                    const dept = tr.author.hcparties.find(hcp => hcp.cds.find(cd => cd.s === "CD-HCPARTY"))
                    if(dept){
                        const cd = dept.cds.find(cd => cd.s === "CD-HCPARTY")
                        authorRes += "/" + cd.value;
                    }
                    return authorRes;
                }else {
                    return "";
                }
            }

            _transactionType(tr){
                if(tr) {
                    const cdTransType = tr.cds.find(cd => cd.s === "CD-TRANSACTION");
                    if (cdTransType) {
                        return cdTransType.value;
                    }
                    else {
                        return "--";
                    }
                } else {
                    return "";
                }
            }

            formatResponse(transInfo, tranResp){
                const slot = this.shadowRoot.querySelector("#kmehr_slot");
                if(tranResp) {
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(tranResp,"text/xml");
                    const req = new XMLHttpRequest();
                    req.onreadystatechange = function(event) {
                        if (this.readyState === XMLHttpRequest.DONE) {
                            if (this.status === 200) {
                                const xsltProcessor = new XSLTProcessor();
                                const xslStylesheet = this.responseXML;
                                xsltProcessor.importStylesheet(xslStylesheet);
                                const fragment = xsltProcessor.transformToFragment(xmlDoc, document);
                                slot.innerHTML = "";
                                slot.appendChild(fragment);
                            } else {
                                slot.innerHTML = "ERROR: XSLT not found";
                            }
                        }
                    };

                    const transtype =  this._transactionType(transInfo);
                    if(transtype == "sumehr") {
                        req.open("GET", "sumehr_to_html.xslt", true);
                        req.send(null);
                    } else if(transtype == "medicationscheme") {
                        req.open("GET", "sumehr_to_html.xslt", true);
                        req.send(null);
                    } else {
                        slot.innerHTML = "No visualizer implemented for transaction of type " + transtype + ":" + tranResp
                    }

                } else {
                    slot.innerHTML = "No transaction found";
                }
            }

            close() {
                this.$.dialog.close();
            }

            _getHcpInfo(hcps){
                let hcpInfo = []

                if(hcps){
                    hcps.map(hcp => {
                        hcp && hcp.cds && hcp.cds.find(cd => cd && cd.s === "CD_HCPARTY") && hcp.cds.find(cd => cd && cd.s === "CD_HCPARTY").value !== "hub" ?
                            hcpInfo.push({
                                name: hcp.name || null,
                                firstName: hcp.firstname || null,
                                familyName: hcp.familyname || null,
                                inss: hcp && hcp.ids && hcp.ids.find(id => id && id.s === 'INSS') && hcp.ids.find(id => id && id.s === 'INSS') ? hcp.ids.find(id => id && id.s === 'INSS').value : null,
                                nihii: hcp && hcp.ids && hcp.ids.find(id => id && id.s === 'ID_HCPARTY') && hcp.ids.find(id => id && id.s === 'ID_HCPARTY').value ? hcp.ids.find(id => id && id.s === 'ID_HCPARTY').value : null,
                                type: hcp && hcp.cds && hcp.cds.find(cd => cd && cd.s === "CD_HCPARTY") && hcp.cds.find(cd => cd && cd.s === "CD_HCPARTY").value ? hcp.cds.find(cd => cd && cd.s === "CD_HCPARTY").value : null,
                                addresses: this._getAdresses(hcp.addresses) || [],
                                telecoms: this._getTelecoms(hcp.telecoms) || []
                            }) : null
                    })
                }

                return hcpInfo
            }

            _getPersonInfo(person){
                let personInfo = {}

                person ?
                    personInfo = {
                        inss: person.ids && person.ids.find(id => id.s === "INSS") && person.ids.find(id => id.s === "INSS").value ? person.ids.find(id => id.s === "INSS").value : null,
                        firstName: person.firstnames.join(' ') || null,
                        familyName: person.familyname || null,
                        birthdate: person.birthdate || null,
                        deathdate: person.deathdate || null,
                        sex : person.sex && person.sex.value || null,
                        addresses: this._getAdresses(person.addresses) || [],
                        telecoms: this._getTelecoms(person.telecoms) || []
                    }
                    : null

                return personInfo

            }


            _getAdresses(addresses){
                let addressesInfo = []
                addresses.map(adr => addressesInfo.push({
                        addressType: adr && adr.cds && adr.cds.find(cd => cd.s === "CD_ADDRESS") && adr.cds.find(cd => cd.s === "CD_ADDRESS").value ? adr.cds.find(cd => cd.s === "CD_ADDRESS").value : null,
                        country: adr && adr.country && adr.country.cd && adr.country.cd.s  && adr.country.cd.s === "CD_FED_COUNTRY" && adr.country.cd.value ? adr.country.cd.value : null,
                        zip: adr.zip || null,
                        nis: adr.nis || null,
                        city: adr.city || null,
                        district : adr.district || null,
                        street : adr.street || null,
                        houseNumber: adr.housenumber || null,
                        postboxNumber :adr.postboxnumber || null
                    })
                )

                return addressesInfo
            }

            _getTelecoms(telecoms){
                let telecomInfo = []
                telecoms.map(tel => telecomInfo.push({
                    addressType: tel && tel.cds && tel.cds.find(cd => cd.s === "CD_ADDRESS") && tel.cds.find(cd => cd.s === "CD_ADDRESS").value ? tel.cds.find(cd => cd.s === "CD_ADDRESS").value : null,
                    telecomType: tel && tel.cds && tel.cds.find(cd => cd.s === "CD_TELECOM") && tel.cds.find(cd => cd.s === "CD_TELECOM").value ? tel.cds.find(cd => cd.s === "CD_TELECOM").value : null,
                    telecomNumber : tel.telecomnumber
                }))

                return telecomInfo
            }

            _processItem(listOfItem){

                let newListOfItem = []

                if(listOfItem){
                    listOfItem.map(item => newListOfItem.push({
                        type: item && item.cds && item.cds.find(cd => cd && cd.s === "CD_ITEM") && item.cds.find(cd => cd && cd.s === "CD_ITEM").value ? item.cds.find(cd => cd && cd.s === "CD_ITEM").value : null,
                        contents: this._getItemsContents(item.contents),
                        beginMoment: item && item.beginmoment && item.beginmoment.date || null,
                        endMoment: item && item.endmoment && item.endmoment.date || null,
                        lifeCycle: item && item.lifecycle && item.lifecycle.cd && item.lifecycle.cd.value || null,
                        isRelevant: item && item.isrelevant || null
                    }))
                }

                return _.orderBy(_.groupBy(newListOfItem, 'type'), ['type'])

            }

            _getItemsContents(contents){
                let contentInfo = []

                if(contents){
                    contents.map(c => {
                        contentInfo.push({
                            authors: this._getHcpInfo(c.hcparty ? [c.hcparty] : null),
                            persons: this._getPersonInfo(c.person || null),
                            cds: this._getContentCds(c.cds),
                            texts: this._getContentTexts(c.texts),
                            medicinalproduct: c.medicinalproduct
                        })


                    })
                }
                return contentInfo
            }

            _getContentCds(cds){
                let cdsInfo = []
                cds ? cds.map(cd => { cdsInfo.push({ s: cd.s, value: cd.value }) }) : null
                return cdsInfo
            }

            _getContentTexts(texts){
                let textInfo = []
                texts ? texts.map(txt => {textInfo.push({txtValue: txt.value,lang: txt.l}) }) : null
                return textInfo
            }

            _getTraduction(type){
                return this.localize(type, type, this.language)
            }

            _getTitle(contents, type){
                return type === "medication" || type === "vaccine" ? _.compact(_.flatten(contents.map(ct => ct.medicinalproduct))).map(med => med.intendedname).join(',') || null : _.flatten(contents.map(ct => ct.texts.map(txt => txt.txtValue))).join(',') || null
            }

            _getCode(contents, type){
                let codeList = []
                contents.map(ct => ct.cds.map(cd => {
                    codeList.push({
                        value: cd.value,
                        code: cd.s === "CD_CLINICAL" ? "Ibui: " :
                            cd.s === "CD_ATC" ? "Atc: " :
                                cd.s === "CD_VACCINEINDICATION" ? "" :
                                    cd.s === "ICD" ? "Icd: " :
                                        cd.s === "ICPC" ? "Icpc: " :
                                            cd.s === "CD_PATIENTWILL" ? "" :
                                                cd.s+": "
                    })
                }))

                return codeList
            }

            _ifTableView(type){
                return type === "gmdmanager" || type === "contactperson" || type === "contacthcparty" ? false : true
            }

            _convertHubDateAsString(timestamp){
                if(timestamp){
                    let date = parseInt(timestamp) / 1000000
                    return this.api.moment(date).format("DD/MM/YYYY")
                }
            }

            _isSumehrType(transInfo){
                return this._transactionType(transInfo) === "sumehr" ? true : false
            }

            _isHcp(type){
                return type === "gmdmanager" || type === "contacthcparty" ? true : false
            }

            _isPerson(type){
                return type === "contactperson" ? true : false
            }

            _isAuthor(hcp){
                return hcp && hcp.length > 0 ? true : false
            }

            _isRedactor(hcp){
                return hcp && hcp.length > 0 ? true : false
            }

            _importDocumentIntoPatientDialog(e){
                this.set('selectedDocumentToBeImported', {
                    transaction : null,
                    document: null,
                    title: null,
                    docType: null
                })

                if(e && e.target && e.target.dataset && e.target.dataset.document && e.target.dataset.transaction){
                    const transaction = JSON.parse(e.target.dataset.transaction)
                    const document = JSON.parse(e.target.dataset.document)
                    const docType = transaction && transaction.cds && transaction.cds.find(cd => cd.s === "CD_TRANSACTION") && transaction.cds.find(cd => cd.s === "CD_TRANSACTION").value ? transaction.cds.find(cd => cd.s === "CD_TRANSACTION").value : 'report'
                    this.set('selectedDocumentToBeImported.transaction', transaction)
                    this.set('selectedDocumentToBeImported.document', document)
                    this.set('selectedDocumentToBeImported.docType', docType)
                    this.$['importHubDocumentDialog'].open()
                }
            }

            _closeImportDialog(){
                this.set('selectedDocumentToBeImported', {
                    transaction : null,
                    document: null,
                    title: null,
                    docType: null
                })
                this.$['importHubDocumentDialog'].close()
            }

            _importDocumentIntoPatient(){
                if(this.selectedDocumentToBeImported && this.selectedDocumentToBeImported.transaction && this.selectedDocumentToBeImported.document){
                    this.api.message().newInstance(this.user)
                        .then(nmi => this.api.message().createMessage(_.merge(nmi, {
                            transportGuid: "HUB:IN:IMPORTED-DOCUMENT",
                            recipients: [this.user && this.user.healthcarePartyId],
                            metas: {filename: "documentDownloadFromHub_"+moment().format("YYYYMMDDhhmmss"), mediaType: this.tranformHubTypeToUti(this.selectedDocumentToBeImported.document)},
                            toAddresses: [_.get(this.user, 'email', this.user && this.user.healthcarePartyId)],
                            subject: "Import document from hub: "+ this.selectedDocumentToBeImported.title || null
                            }))
                            .then(createdMessage => this.api.document().newInstance(this.user, createdMessage, {
                                documentType: this.selectedDocumentToBeImported && this.selectedDocumentToBeImported.docType ? this.selectedDocumentToBeImported.docType : 'report',
                                mainUti: this.api.document().uti(this.tranformHubTypeToUti(this.selectedDocumentToBeImported.document)),
                                name: this.selectedDocumentToBeImported && this.selectedDocumentToBeImported.title ? this.selectedDocumentToBeImported.title : "documentDownloadFromHub_"+moment().format("YYYYMMDDhhmmss")
                            }))
                            .then(newDocInstance => this.api.document().createDocument(newDocInstance))
                            .then(createdDocument => this.api.encryptDecryptFileContentByUserHcpIdAndDocumentObject('encrypt', this.user, createdDocument, this.api.crypto().utils.base64toArrayBuffer(this.selectedDocumentToBeImported.document.value))
                                .then(encryptedFileContent => ({createdDocument, encryptedFileContent })))
                            .then(({createdDocument, encryptedFileContent}) => this.api.document().setAttachment(createdDocument.id, null, encryptedFileContent))
                            .then(resourcesObject => {
                                //Import into currentContact
                                let sc = this.currentContact.subContacts.find(sbc => (sbc.status || 0) & 64);
                                if (!sc) {
                                    sc = { status: 64, services: [] };
                                    this.currentContact.subContacts.push(sc);
                                }
                                const svc = this.api.contact().service().newInstance(this.user, { content: _.fromPairs([[this.language, { documentId: resourcesObject.id, stringValue: resourcesObject.name }]]), label: 'document' });
                                this.currentContact.services.push(svc);
                                sc.services.push({ serviceId: svc.id });

                                this.saveCurrentContact().then(c => {
                                    this.dispatchEvent(new CustomEvent('hub-download', {}))
                                })

                                /*
                                //Import in new contact
                                this.api.contact().newInstance(this.user, this.patient, {
                                    created: new Date().getTime() ,
                                    modified: new Date().getTime() ,
                                    author: this.user.id,
                                    responsible: this.user.healthcarePartyId,
                                    subContacts: []
                                }).then(ctc => {
                                    if (resourcesObject && resourcesObject.id) {
                                        const svc = this.api.contact().service().newInstance(this.user, { content: _.fromPairs([[this.language, { documentId: resourcesObject.id, stringValue: resourcesObject.name }]]), label: 'Hub document'});
                                        ctc.services.push(svc);
                                        ctc.subContacts = [{ status: 64, services: [{serviceId: svc.id }]}]
                                        this.api.contact().createContactWithUser(this.user, ctc).then(c=>{
                                            this.api.register(c,'contact')
                                        })
                                    }
                                })*/
                            }).finally(() => {
                                this.set('selectedDocumentToBeImported', {
                                    transaction : null,
                                    document: null,
                                    title: null,
                                    docType: null
                                })
                                this.$['importHubDocumentDialog'].close()
                            }).catch(e => {
                                console.log("---error upload attachment---", e)
                            })
                        )
                }
            }

            tranformHubTypeToUti(docInfo){
                return docInfo && docInfo.mediatype ? _.toLower(_.split(docInfo.mediatype,'_').join('/')) : "application/pdf"
            }

            saveCurrentContact() {
                if(!this.currentContact.id ) {
                    this.currentContact.id = this.api.crypto().randomUuid()
                }
                return (this.currentContact.rev ? this.api.contact().modifyContactWithUser(this.user, this.currentContact) : this.api.contact().createContactWithUser(this.user, this.currentContact)).then(c=>this.api.register(c,'contact')).then(c => (this.currentContact.rev = c.rev) && c);
            }


        }
        customElements.define(HtPatHubTransactionViewSecond.is, HtPatHubTransactionViewSecond);
    </script>
</dom-module>
